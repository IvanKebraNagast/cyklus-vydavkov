<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sledovanie vÃ½davkov</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
body {
Â  Â  font-family: 'Inter', sans-serif;
}
.modal {
Â  Â  background-color: rgba(0, 0, 0, 0.5);
Â  Â  transition: opacity 0.3s ease-in-out;
}
.modal-content {
Â  Â  animation: fadeInScale 0.3s ease-in-out forwards;
}
.sidebar {
Â  Â  transition: transform 0.3s ease-in-out;
}
@keyframes fadeInScale {
Â  Â  from {
Â  Â  Â  Â  opacity: 0;
Â  Â  Â  Â  transform: scale(0.95);
Â  Â  }
Â  Â  to {
Â  Â  Â  Â  opacity: 1;
Â  Â  Â  Â  transform: scale(1);
Â  Â  }
}
@media print {
Â  Â  .no-print {
Â  Â  Â  Â  display: none !important;
Â  Â  }
Â  Â  .print-area {
Â  Â  Â  Â  display: block !important;
Â  Â  Â  Â  position: static;
Â  Â  Â  Â  top: auto;
Â  Â  Â  Â  left: auto;
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  height: auto;
Â  Â  Â  Â  background: none;
Â  Â  Â  Â  z-index: auto;
Â  Â  }
Â  Â  body, html {
Â  Â  Â  Â  height: auto;
Â  Â  Â  Â  overflow: visible;
Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  padding: 0;
Â  Â  }
}
.print-header { text-align: center; margin-bottom: 2rem; }
.print-header h1 { font-size: 2rem; font-weight: bold; color: #1e3a8a; }
.print-header p { color: #4b5563; }
.print-section { margin-bottom: 2rem; }
.print-section h2 { font-size: 1.5rem; font-weight: bold; color: #1f2937; margin-bottom: 1rem; }
.print-content-row { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 2rem; }
.print-chart-container, .print-table-container { flex: 1; min-width: 300px; }
.print-legend { display: flex; flex-direction: column; gap: 0.5rem; margin-top: 1rem; }
.print-legend-item { display: flex; align-items: center; gap: 0.5rem; }
.print-legend-color { width: 1rem; height: 1rem; border-radius: 9999px; }
.print-table { width: 100%; border-collapse: collapse; text-align: left; margin-top: 1rem; }
.print-table th, .print-table td { border: 1px solid #d1d5db; padding: 0.75rem; }
.print-table th { background-color: #e5e7eb; color: #4b5563; font-weight: bold; }
.print-table td { color: #1f2937; }
.print-summary { margin-top: 2rem; border-top: 1px solid #d1d5db; padding-top: 1rem; }
.print-summary p { font-size: 1.2rem; margin-bottom: 0.5rem; }
.print-total { font-weight: bold; }
.print-button-container {
Â  Â  position: fixed;
Â  Â  top: 1rem;
Â  Â  right: 1rem;
Â  Â  display: flex;
Â  Â  gap: 0.5rem;
Â  Â  z-index: 1000;
}
.print-button, .back-button {
Â  Â  background-color: #dc2626;
Â  Â  color: #fff;
Â  Â  font-weight: bold;
Â  Â  padding: 0.75rem 1.5rem;
Â  Â  border-radius: 0.5rem;
Â  Â  box-shadow: 0 4px 6px -1-2px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
Â  Â  transition: background-color 0.2s ease-in-out;
Â  Â  cursor: pointer;
Â  Â  border: none;
Â  Â  display: flex;
Â  Â  align-items: center;
Â  Â  gap: 0.5rem;
}
.print-button:hover, .back-button:hover {
Â  Â  background-color: #991b1b;
}
</style>
</head>
<body class="bg-gray-100 flex min-h-screen p-4">

<!-- HlavnÃ½ obsah aplikÃ¡cie -->
<div id="main-content" class="container mx-auto bg-white shadow-xl rounded-2xl p-8 space-y-8 max-w-4xl">

<header class="text-center">
<h1 class="text-4xl font-bold text-blue-900 mb-2">Sledovanie vÃ½davkov</h1>
<div class="inline-block px-4 py-1.5 bg-gray-200 rounded-full text-gray-700 text-sm font-medium">
Vytvoril: IvanKebraNagast
</div>
<p id="cycle-dates" class="text-gray-600">
Sledovanie rozpoÄtu.
</p>
</header>

<!-- Sekcia pre sprÃ¡vu cyklov -->
<section class="bg-gray-50 p-6 rounded-xl border border-gray-200 flex flex-col md:flex-row items-center justify-between gap-4 no-print">
<h2 class="text-xl font-bold text-gray-800">SprÃ¡va cyklov</p>
<div class="flex gap-4 w-full md:w-auto">
<button id="start-new-cycle-btn" class="flex-1 px-6 py-2.5 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 focus:ring-4 focus:ring-blue-500 focus:outline-none">
UkonÄiÅ¥ aktuÃ¡lny cyklus a zaÄaÅ¥ novÃ½
</button>
<button id="view-history-btn" class="flex-1 px-6 py-2.5 bg-gray-600 text-white font-bold rounded-lg shadow-md hover:bg-gray-700 focus:ring-4 focus:ring-gray-500 focus:outline-none">
ZobraziÅ¥ histÃ³riu
</button>
</div>
</section>

<!-- ZjednotenÃ¡ sekcia s formulÃ¡rmi pre aktuÃ¡lny cyklus -->
<div id="current-cycle-forms">
<!-- New sections for income and budget summary -->
<section class="bg-gray-50 p-6 rounded-xl border border-gray-200 grid grid-cols-1 md:grid-cols-3 gap-4 no-print">
<div class="flex flex-col items-start space-y-2">
<label for="monthly-income-input" class="text-sm font-medium text-gray-700">CelkovÃ½ prÃ­jem (â‚¬)</label>
<input type="number" id="monthly-income-input" placeholder="0.00" step="0.01" class="w-full px-4 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
<button id="save-income-btn" class="w-full px-6 py-2.5 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 focus:ring-4 focus:ring-green-500 focus:outline-none">UloÅ¾iÅ¥ prÃ­jem</button>
</div>
<div class="flex flex-col items-center justify-center bg-blue-100 p-4 rounded-lg">
<span class="text-sm font-medium text-blue-800">Minul som</span>
<span id="total-spent" class="text-2xl font-bold text-blue-600 mt-1">0.00 â‚¬</span>
</div>
<div id="remaining-budget-container" class="flex flex-col items-center justify-center p-4 rounded-lg">
<span class="text-sm font-medium text-green-800">ZostÃ¡va mi</span>
<span id="remaining-budget" class="text-2xl font-bold mt-1">0.00 â‚¬</span>
</div>
</section>

<!-- Budget Rule section -->
<section class="bg-gray-50 p-6 rounded-xl border border-gray-200 no-print">
<h2 class="text-2xl font-bold text-gray-800 mb-4">RozpoÄtovÃ© pravidlo</h2>
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
<div class="input-group">
<label for="budget-category-select" class="block text-sm text-gray-700 mb-1">PoloÅ¾ka pre rozpoÄet</label>
<select id="budget-category-select" class="w-full px-4 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white">
<!-- Options will be added dynamically -->
</select>
</div>
<div class="input-group">
<label for="budget-amount-input" class="block text-sm text-gray-700 mb-1">RozpoÄet (â‚¬)</label>
<input type="number" id="budget-amount-input" placeholder="100.00" step="0.01" class="w-full px-4 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
</div>
<button id="save-budget-btn" class="w-full px-6 py-2.5 bg-yellow-600 text-white font-bold rounded-lg shadow-md hover:bg-yellow-700 focus:ring-4 focus:ring-yellow-500 focus:outline-none">
UloÅ¾iÅ¥ rozpoÄet
</button>
</div>
<div id="budget-bar-chart-container" class="relative w-full max-w-2xl mx-auto mt-6 hidden">
<canvas id="budget-bar-chart"></canvas>
</div>
<!-- PridanÃ½ kontajner pre zobrazenie stavu rozpoÄtov -->
<div id="budget-status-container" class="mt-6 space-y-4"></div>
</section>

<!-- Add new expense section -->
<section class="bg-gray-50 p-6 rounded-xl border border-gray-200 no-print">
<h2 class="text-2xl font-bold text-gray-800 mb-4">PridaÅ¥ novÃ½ vÃ½davok</h2>
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
<div class="input-group" id="expense-category-container">
<label for="expense-category" class="block text-sm text-gray-700 mb-1">PoloÅ¾ka</label>
<select id="expense-category" class="w-full px-4 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white">
<!-- Options will be added dynamically, including "VlastnÃ¡ poloÅ¾ka" -->
</select>
</div>

<!-- NOVÃ‰ POLE PRE VLASTNÃš KATEGÃ“RIU -->
<div class="input-group hidden" id="custom-category-input-group">
<label for="custom-category-input" class="block text-sm text-gray-700 mb-1">VlastnÃ¡ poloÅ¾ka</label>
<input type="text" id="custom-category-input" placeholder="Napr. DarÄek pre Petra" class="w-full px-4 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
</div>
<!-- KONIEC NOVÃ‰HO POÄ½A -->

<div class="input-group">
<label for="expense-amount" class="block text-sm text-gray-700 mb-1">Suma (â‚¬)</label>
<input type="number" id="expense-amount" placeholder="50.00" step="0.01" class="w-full px-4 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
</div>
<button id="add-expense-btn" class="w-full px-6 py-2.5 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 focus:ring-4 focus:ring-blue-500 focus:outline-none">
PridaÅ¥
</button>
</div>
</section>
</div>

<!-- Sekcia so sprÃ¡vou pre historickÃ½ reÅ¾im -->
<div id="history-view-message" class="hidden bg-gray-200 p-6 rounded-xl text-center">
<p class="text-xl font-bold text-gray-700">MomentÃ¡lne prezerÃ¡te historickÃ½ cyklus.</p>
<p class="text-sm text-gray-600 mt-2">DÃ¡ta sÃº len na ÄÃ­tanie. Ak chcete pridÃ¡vaÅ¥ vÃ½davky, vrÃ¡Å¥te sa k aktuÃ¡lnemu cyklu.</p>
</div>

<!-- HLAVNÃ DVOJSTÄ¹PCOVÃ SEKCIA -->
<section class="flex flex-col lg:flex-row gap-8">

    <!-- Ä½AVÃ STRANA â€“ PIE GRAF + LEGENDA + SÃšHRN -->
    <div class="flex-1 bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-sm">

        <!-- Nadpis -->
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Graf vÃ½davkov</h2>

        <!-- Graf + Legenda -->
        <div class="relative w-full max-w-sm mx-auto">
            <canvas id="expense-pie-chart"></canvas>

            <div id="chart-legend"
                 class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-2 text-sm text-gray-700">
            </div>
        </div>

        <!-- SÃšHRNNÃ TABUÄ½KA POD GRAFOM -->
        <div id="summary-table-container" class="mt-8">
            <h3 class="text-xl font-bold text-gray-800 mb-2">SÃºhrn vÃ½davkov podÄ¾a kategÃ³rie</h3>

            <table class="min-w-full border border-gray-300 text-left">
                <thead>
                    <tr class="bg-gray-200 text-gray-700 text-sm uppercase">
                        <th class="py-2 px-4">KategÃ³ria</th>
                        <th class="py-2 px-4">Suma (â‚¬)</th>
                    </tr>
                </thead>
                <tbody id="summary-table-body">
                    <!-- dynamickÃ© dÃ¡ta -->
                </tbody>
            </table>
        </div>
    </div>


    <!-- PRAVÃ STRANA â€“ DETAILNÃ TABUÄ½KA VÃDAVKOV -->
    <div class="flex-1 bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-sm overflow-x-auto">

        <h2 class="text-2xl font-bold text-gray-800 mb-4">PrehÄ¾ad vÃ½davkov</h2>

        <table class="min-w-full table-auto text-center">
            <thead>
                <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                    <th class="py-3 px-6 text-left">DÃ¡tum a poloÅ¾ka</th>
                    <th class="py-3 px-6 text-left">Suma (â‚¬)</th>
                </tr>
            </thead>
            <tbody id="expense-table-body" class="text-gray-700 text-sm font-light">
                <!-- dynamickÃ© dÃ¡ta -->
            </tbody>
        </table>

        <button id="delete-current-cycle-btn"
            class="mt-4 w-full px-6 py-2.5 bg-red-600 text-white font-bold rounded-lg shadow-md hover:bg-red-700 focus:ring-4 focus:ring-red-500 focus:outline-none no-print">
            VymazaÅ¥ dÃ¡ta aktuÃ¡lneho cyklu
        </button>

    </div>

</section>


<!-- ROZPOÄŒTOVÃ‰ PRAVIDLO PEKNE POD TÃM -->
<section id="budget-section"
         class="bg-gray-50 p-6 rounded-xl border border-gray-200 mt-8 shadow-sm">

    <h2 class="text-2xl font-bold text-gray-800 mb-4">RozpoÄtovÃ© pravidlo</h2>

    <!-- StÄºpcovÃ½ graf -->
    <div id="budget-bar-chart-container"
         class="relative w-full max-w-2xl mx-auto mt-6 hidden">
        <canvas id="budget-bar-chart"></canvas>
    </div>

    <!-- FarebnÃ© stavovÃ© boxy -->
    <div id="budget-status-container" class="mt-6 space-y-4"></div>

</section>


<!-- Expense table -->
<div class="flex-1 bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-sm overflow-x-auto flex flex-col">
<h2 class="text-2xl font-bold text-gray-800 mb-4">PrehÄ¾ad vÃ½davkov</h2>
<div class="table-container">
<table class="min-w-full table-auto text-center">
<thead>
<tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
<th class="py-3 px-6 text-left">DÃ¡tum a poloÅ¾ka</th>
<th class="py-3 px-6 text-left">Suma (â‚¬)</th>
</tr>
</thead>
<tbody id="expense-table-body" class="text-gray-700 text-sm font-light">
<!-- Rows will be added dynamically -->
</tbody>
</table>
</div>
<button id="delete-current-cycle-btn" class="mt-4 w-full px-6 py-2.5 bg-red-600 text-white font-bold rounded-lg shadow-md hover:bg-red-700 focus:ring-4 focus:ring-red-500 focus:outline-none no-print">
VymazaÅ¥ dÃ¡ta aktuÃ¡lneho cyklus
</button>
</div>
</section>

<!-- TlaÄidlo pre otvorenie tlaÄovÃ©ho okna - viditeÄ¾nÃ© len na hlavnej strÃ¡nke -->
<section class="mt-4 flex justify-center">
<button id="print-all-btn" class="flex items-center gap-2 px-6 py-2.5 bg-gray-600 text-white font-bold rounded-lg shadow-md hover:bg-gray-700 focus:ring-4 focus:ring-gray-500 focus:outline-none">
Â  Â  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" style="width: 1rem; height: 1rem; fill: currentColor;"><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64c0-17.7 14.3-32 32-32H352c17.7 0 32 14.3 32 32v96h64V64c0-35.3-28.7-64-64-64H128zM0 192c0-35.3 28.7-64 64-64H448c35.3 0 64 28.7 64 64v32V416c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V224 192zm64 64V416H448V256H64zM200 352h112c4.4 0 8-3.6 8-8c0-4.4-3.6-8-8-8H200c-4.4 0-8 3.6-8 8c0 4.4 3.6 8 8 8z"/></svg>
Â  Â  TlaÄiÅ¥
</button>
</section>

<!-- Success or error message -->
<div id="message-box" class="fixed bottom-4 left-1/2 -translate-x-1/2 p-4 rounded-xl shadow-lg transition-all duration-300 hidden no-print" style="transform: translateX(-50%);">
<p id="message-text" class="font-medium text-white"></p>
</div>

<!-- Confirmation dialog -->
<div id="confirmation-dialog" class="modal fixed inset-0 flex items-center justify-center p-4 z-50 hidden no-print">
<div class="modal-content bg-white rounded-xl shadow-2xl p-8 max-w-sm mx-auto space-y-6">
<h3 class="text-2xl font-bold text-gray-800">Potvrdenie</h3>
<p id="confirmation-message" class="text-gray-700">Naozaj chcete ukoniÅ¥ aktuÃ¡lny rozpoÄtovÃ½ cyklus a zaÄaÅ¥ novÃ½? AktuÃ¡lne dÃ¡ta budÃº uloÅ¾enÃ© a aplikÃ¡cia sa vynuluje.</p>
<div class="flex justify-end gap-4">
<button id="cancel-btn" class="px-6 py-2.5 bg-gray-300 text-gray-800 font-bold rounded-lg hover:bg-gray-400">
ZruÅ¡iÅ¥
</button>
<button id="confirm-btn" class="px-6 py-2.5 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700">
PotvrdiÅ¥
</button>
</div>
</div>
</div>
</div>

<!-- BoÄnÃ½ panel pre histÃ³riu cyklov -->
<div id="history-sidebar" class="sidebar fixed top-0 right-0 h-full w-80 bg-gray-900 text-white p-6 transform translate-x-full z-40 shadow-lg overflow-y-auto no-print">
<div class="flex justify-between items-center mb-6">
<h2 class="text-2xl font-bold">HistÃ³ria cyklov</h2>
<button id="close-history-btn" class="text-2xl font-bold hover:text-gray-400">Ã—</button>
</div>
<div id="history-list" class="space-y-4">
<!-- HistorickÃ© cykly sa tu zobrazia dynamicky -->
</div>
<button id="delete-history-btn" class="mt-4 w-full px-6 py-2.5 bg-red-600 text-white font-bold rounded-lg shadow-md hover:bg-red-700 focus:ring-4 focus:ring-red-500 focus:outline-none">
VymazaÅ¥ celÃº histÃ³riu
</button>
<button id="back-to-current-btn" class="mt-4 w-full px-6 py-2.5 bg-gray-500 text-white font-bold rounded-lg shadow-md hover:bg-gray-600 focus:ring-4 focus:ring-gray-400 focus:outline-none">
SpÃ¤Å¥ na aktuÃ¡lny cyklus
</button>
</div>

<!-- Kontajner pre tlaÄ - viditeÄ¾nÃ½ iba pri tlaÄi, uÅ¾ sa nepouÅ¾Ã­va, je to nahradenÃ© priamym zÃ¡pisom do novÃ©ho okna -->
<div class="print-area"></div>

<!-- PridanÃ½ plugin pre zobrazenie dÃ¡tovÃ½ch nÃ¡vestÃ­ (data labels) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script>
// Global variables for application state
let expenses = [];
let pieChart;
let budgetChart;
let monthlyIncome = 0;
let monthlyBudget = {}; // Store budgets per category
let messageTimeout;
let cycleStartDate = null; // New variable to store the start date of the cycle

// This is now the key for the CURRENT cycle
const currentCycleKey = 'expenseTrackerData-current';
const archiveKeyPrefix = 'expenseTrackerData-archived-';
let isHistoryView = false;

// Expense categories
let expenseCategories = [
'NÃ¡jomnÃ©',
'Internet',
'Elektrika',
'KÃºrenie',
'Poistka za auto',
'Poistenie zodpovednosti za byt',
'Potraviny',
'Doprava',
'ZÃ¡bava',
'Cigarety',
'Alkohol',
'OstatnÃ©'
];

// NOVÃ KONÅ TANTA PRE VLASTNÃš POLOÅ½KU
const CUSTOM_CATEGORY_OPTION = 'CUSTOM_CATEGORY_INPUT';

/**
* Combines initial categories with any custom categories saved in expenses/budgets.
*/
function getAllCategories() {
    let allCategories = new Set(expenseCategories);
    expenses.forEach(e => allCategories.add(e.category));
    Object.keys(monthlyBudget).forEach(b => allCategories.add(b));
    return Array.from(allCategories).sort();
}


/**
* Saves the current application state to localStorage.
*/
function saveDataToLocalStorage(key = currentCycleKey) {
const data = {
expenses,
monthlyIncome,
monthlyBudget,
cycleStartDate: cycleStartDate ? cycleStartDate.toISOString() : null,
};
localStorage.setItem(key, JSON.stringify(data));
}

/**
* Loads the application state from localStorage.
*/
function loadDataFromLocalStorage(key = currentCycleKey) {
const data = JSON.parse(localStorage.getItem(key));
if (data) {
expenses = data.expenses || [];
monthlyIncome = data.monthlyIncome || 0;
monthlyBudget = data.monthlyBudget || {};
cycleStartDate = data.cycleStartDate ? new Date(data.cycleStartDate) : null;
document.getElementById('monthly-income-input').value = monthlyIncome;
} else {
expenses = [];
monthlyIncome = 0;
monthlyBudget = {};
cycleStartDate = null;
}
}

/**
* Renders all UI components based on current global state.
*/
function renderAllUI() {
const historyMessageEl = document.getElementById('history-view-message');
const currentFormsEl = document.getElementById('current-cycle-forms');
const chartSection = document.getElementById('pie-chart-section');
const budgetRuleSection = document.querySelector('section:nth-of-type(3)');
const deleteBtn = document.getElementById('delete-current-cycle-btn');
const printBtn = document.getElementById('print-all-btn');

// MUSÃ BYÅ¤ PRVÃ‰: PrekreslÃ­ vÅ¡etky dropdown menu
renderUI(); 

if (isHistoryView) {
currentFormsEl.classList.add('hidden');
chartSection.classList.add('hidden');
budgetRuleSection.classList.add('hidden');
deleteBtn.classList.add('hidden');
historyMessageEl.classList.remove('hidden');
printBtn.textContent = 'VytlaÄiÅ¥ historickÃ½ prehÄ¾ad';
} else {
currentFormsEl.classList.remove('hidden');
chartSection.classList.remove('hidden');
budgetRuleSection.classList.remove('hidden');
deleteBtn.classList.remove('hidden');
historyMessageEl.classList.add('hidden');
printBtn.textContent = 'VytlaÄiÅ¥ prehÄ¾ad';
updateChart();
updateBudgetRuleChart();
// Zobrazenie stavu rozpoÄtov
updateBudgetStatus();
}

renderTable();
updateBudgetSummary();
updateCycleDatesDisplay();
}

/**
* Archives the current cycle and starts a new, clean one.
*/
function startNewCycle() {
if (expenses.length === 0 && monthlyIncome === 0) {
showMessage('Nie sÃº Å¾iadne dÃ¡ta na ukonÄenie aktuÃ¡lneho cyklu.', 'error');
return;
}

showConfirmationDialog('Naozaj chcete ukonÄiÅ¥ aktuÃ¡lny rozpoÄtovÃ½ cyklus a zaÄaÅ¥ novÃ½? AktuÃ¡lne dÃ¡ta budÃº uloÅ¾enÃ© a aplikÃ¡cia sa vynuluje.', () => {
const cycleEndDate = new Date();
const archiveKey = `${archiveKeyPrefix}${cycleEndDate.toISOString()}`;

const dataToArchive = JSON.parse(localStorage.getItem(currentCycleKey));
if (dataToArchive) {
const finalData = {
dataToArchive,
cycleStartDate: dataToArchive.cycleStartDate || cycleEndDate.toISOString(),
cycleEndDate: cycleEndDate.toISOString(),
};
localStorage.setItem(archiveKey, JSON.stringify(finalData));
}

expenses = [];
monthlyIncome = 0;
monthlyBudget = {};
cycleStartDate = null;
saveDataToLocalStorage();

document.getElementById('monthly-income-input').value = '';
document.getElementById('budget-amount-input').value = '';
renderAllUI(); // PouÅ¾Ã­vame renderAllUI, aby sa prekreslili aj dropdown menu
isHistoryView = false;
renderAllUI();

showMessage('Bol spustenÃ½ novÃ½ rozpoÄtovÃ½ cyklus!', 'success');
});
}

/**
* Loads and displays data for a specific archived cycle.
*/
function loadArchivedCycle(key) {
const data = JSON.parse(localStorage.getItem(key));
if (data) {
expenses = data.expenses || [];
monthlyIncome = data.monthlyIncome || 0;
monthlyBudget = data.monthlyBudget || {};
const start = data.cycleStartDate ? new Date(data.cycleStartDate) : null;
const end = data.cycleEndDate ? new Date(data.cycleEndDate) : null;

cycleStartDate = start;

isHistoryView = true;

updateCycleDatesDisplay(start, end);
document.getElementById('monthly-income-input').value = monthlyIncome;

showMessage('Zobrazujem historickÃ½ cyklus.', 'info');

renderAllUI();

document.getElementById('history-sidebar').classList.add('translate-x-full');
}
}

/**
* Switches back to the current cycle view.
*/
function backToCurrentCycle() {
loadDataFromLocalStorage(currentCycleKey);
isHistoryView = false;
document.getElementById('history-sidebar').classList.add('translate-x-full');
showMessage('SpÃ¤Å¥ pri aktuÃ¡lnom cykle.', 'info');

renderAllUI();
}

/**
* Displays archived cycles in the sidebar.
*/
function renderHistorySidebar() {
const historyList = document.getElementById('history-list');
historyList.innerHTML = '';

const archivedKeys = Object.keys(localStorage).filter(key => key.startsWith(archiveKeyPrefix));

if (archivedKeys.length === 0) {
historyList.innerHTML = `<p class="text-gray-400">ZatiaÄ¾ Å¾iadna histÃ³ria cyklov.</p>`;
return;
}

const sortedKeys = archivedKeys.sort().reverse();

sortedKeys.forEach(key => {
const data = JSON.parse(localStorage.getItem(key));
if (!data || !data.cycleStartDate || !data.cycleEndDate) {
return;
}

const start = new Date(data.cycleStartDate);
const end = new Date(data.cycleEndDate);

const totalSpent = (data.expenses || []).reduce((sum, expense) => sum + expense.amount, 0);
const remaining = (data.monthlyIncome || 0) - totalSpent;

const cycleItem = document.createElement('div');
cycleItem.className = 'bg-gray-800 p-4 rounded-lg flex justify-between items-center transition-colors duration-200';

const contentDiv = document.createElement('div');
contentDiv.className = 'flex-grow cursor-pointer hover:text-gray-400';
contentDiv.innerHTML = `
<h4 class="font-bold text-lg">Cyklus: od ${start.toLocaleDateString('sk-SK')} do ${end.toLocaleDateString('sk-SK')}</h4>
<p class="text-sm text-gray-400">PrÃ­jem: ${data.monthlyIncome.toFixed(2)} â‚¬</p>
<p class="text-sm text-gray-400">Zostatok: ${remaining.toFixed(2)} â‚¬</p>
`;
contentDiv.addEventListener('click', () => {
    loadArchivedCycle(key);
});
cycleItem.appendChild(contentDiv);

const deleteBtn = document.createElement('button');
deleteBtn.className = 'text-gray-500 hover:text-red-500 transition-colors duration-200 ml-4';
deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
deleteBtn.title = 'VymazaÅ¥ tento cyklus';
deleteBtn.addEventListener('click', () => {
    deleteSingleCycle(key, `od ${start.toLocaleDateString('sk-SK')} do ${end.toLocaleDateString('sk-SK')}`);
});
cycleItem.appendChild(deleteBtn);

historyList.appendChild(cycleItem);
});
}

/**
 * Handles the deletion of a single archived cycle.
 */
function deleteSingleCycle(key, dateRange) {
    showConfirmationDialog(`Naozaj chcete natrvalo vymazaÅ¥ cyklus pre obdobie: ${dateRange}? TÃºto akciu nie je moÅ¾nÃ© vrÃ¡tiÅ¥ spÃ¤Å¥.`, () => {
        localStorage.removeItem(key);
        renderHistorySidebar();
        showMessage('Cyklus bol ÃºspeÅ¡ne vymazanÃ½.', 'success');
    });
}

/**
 * Handles the deletion of all archived cycles.
 */
function handleDeleteHistory() {
showConfirmationDialog('Naozaj chcete natrvalo vymazaÅ¥ VÅ ETKY historickÃ© cykly? TÃºto akciu nie je moÅ¾nÃ© vrÃ¡tiÅ¥ spÃ¤Å¥.', () => {
    const archivedKeys = Object.keys(localStorage).filter(key => key.startsWith(archiveKeyPrefix));
    archivedKeys.forEach(key => localStorage.removeItem(key));
    renderHistorySidebar();
    showMessage('CelÃ¡ histÃ³ria bola ÃºspeÅ¡ne vymazanÃ¡.', 'success');
});
}


function showMessage(msg, type = 'success') {
const messageBox = document.getElementById('message-box');
const messageText = document.getElementById('message-text');

clearTimeout(messageTimeout);

messageText.textContent = msg;
messageBox.classList.remove('hidden', 'bg-green-500', 'bg-red-500', 'bg-blue-500');

if (type === 'success') {
messageBox.classList.add('bg-green-500');
} else if (type === 'error') {
messageBox.classList.add('bg-red-500');
} else {
messageBox.classList.add('bg-blue-500');
}

messageTimeout = setTimeout(() => {
messageBox.classList.add('hidden');
}, 3000);
}

function showConfirmationDialog(message, onConfirm) {
const dialog = document.getElementById('confirmation-dialog');
const messageEl = document.getElementById('confirmation-message');
const confirmBtn = document.getElementById('confirm-btn');
const cancelBtn = document.getElementById('cancel-btn');

messageEl.textContent = message;
dialog.classList.remove('hidden');

// Function to close the dialog and remove listeners
const closeDialog = () => {
Â  Â  dialog.classList.add('hidden');
Â  Â  confirmBtn.removeEventListener('click', handleConfirm);
Â  Â  cancelBtn.removeEventListener('click', handleCancel);
Â  Â  // Remove the outside click listener as well
Â  Â  dialog.removeEventListener('click', handleOutsideClick);Â 
};

const handleConfirm = () => {
Â  Â  onConfirm();
Â  Â  closeDialog();
};

const handleCancel = () => {
Â  Â  closeDialog();
};

const handleOutsideClick = (event) => {
Â  Â  // If the click target is the dialog itself (the overlay), not a child of the modal content
Â  Â  if (event.target === dialog) {
Â  Â  Â  Â  closeDialog();
Â  Â  }
};

confirmBtn.addEventListener('click', handleConfirm);
cancelBtn.addEventListener('click', handleCancel);
// Add listener for clicks outside the modal content
dialog.addEventListener('click', handleOutsideClick);
}

function handleAddExpense() {
if (isHistoryView) {
showMessage('NemÃ´Å¾ete pridÃ¡vaÅ¥ vÃ½davky do historickÃ©ho cyklu. VrÃ¡Å¥te sa k aktuÃ¡lnemu cyklu.', 'error');
return;
}

const expenseAmount = parseFloat(document.getElementById('expense-amount').value);

if (isNaN(expenseAmount) || expenseAmount <= 0) {
showMessage('ProsÃ­m, zadajte platnÃº sumu.', 'error');
return;
}

let expenseCategory = document.getElementById('expense-category').value;
const customCategoryInput = document.getElementById('custom-category-input');

if (expenseCategory === CUSTOM_CATEGORY_OPTION) {
    // Ak je zvolenÃ¡ vlastnÃ¡ poloÅ¾ka, pouÅ¾ije sa hodnota z textovÃ©ho poÄ¾a
    expenseCategory = customCategoryInput.value.trim();
    if (expenseCategory === '') {
        showMessage('ProsÃ­m, zadajte nÃ¡zov vlastnej poloÅ¾ky.', 'error');
        return;
    }
}

expenses.push({
date: new Date().toISOString(),
category: expenseCategory,
amount: expenseAmount,
});
showMessage(`VÃ½davok bol ÃºspeÅ¡ne pridanÃ½!`, 'success');

// Vynulovanie formulÃ¡ra
document.getElementById('expense-amount').value = '';
document.getElementById('expense-category').value = expenseCategories[0] || ''; // NastavÃ­ spÃ¤Å¥ na prvÃº kategÃ³riu
customCategoryInput.value = '';
document.getElementById('custom-category-input-group').classList.add('hidden'); // Skryje pole pre vlastnÃº kategÃ³riu

saveDataToLocalStorage();
renderAllUI(); // MUSÃ BYÅ¤ renderAllUI, aby sa aktualizovali dropdown menu, ak bola pridanÃ¡ novÃ¡ kategÃ³ria
}

function handleDeleteCurrentCycle() {
if (isHistoryView) {
showMessage('NemÃ´Å¾ete mazaÅ¥ dÃ¡ta v historickom cykle. VrÃ¡Å¥te sa k aktuÃ¡lnemu cyklu.', 'error');
return;
}

if (expenses.length === 0 && monthlyIncome === 0) {
showMessage('Nie sÃº Å¾iadne dÃ¡ta na vymazanie v aktuÃ¡lnom cykle.', 'error');
return;
}

showConfirmationDialog('Naozaj chcete vymazaÅ¥ VÅ ETKY dÃ¡ta (vÃ½davky, prÃ­jem a rozpoÄty) za AKTUÃLNY cyklus?', () => {
expenses = [];
monthlyIncome = 0;
monthlyBudget = {};
cycleStartDate = null;

saveDataToLocalStorage();
renderAllUI();
showMessage('DÃ¡ta za aktuÃ¡lny cyklus boli ÃºspeÅ¡ne vymazanÃ©.', 'success');
});
}

function handleSaveIncome() {
if (isHistoryView) {
showMessage('NemÃ´Å¾ete ukladaÅ¥ prÃ­jem do historickÃ©ho cyklu. VrÃ¡Å¥te sa k aktuÃ¡lnemu cyklu.', 'error');
return;
}
const income = parseFloat(document.getElementById('monthly-income-input').value);
if (isNaN(income) || income < 0) {
showMessage('Zadajte platnÃ½ prÃ­jem.', 'error');
return;
}
monthlyIncome = income;

if (!cycleStartDate) {
cycleStartDate = new Date();
}

showMessage('PrÃ­jem bol uloÅ¾enÃ½!', 'success');

saveDataToLocalStorage();
renderAllUI();
}

function handleSaveBudget() {
if (isHistoryView) {
showMessage('NemÃ´Å¾ete ukladaÅ¥ rozpoÄty do historickÃ©ho cyklu. VrÃ¡Å¥te sa k aktuÃ¡lnemu cyklu.', 'error');
return;
}
const category = document.getElementById('budget-category-select').value;
const budgetAmount = parseFloat(document.getElementById('budget-amount-input').value);
if (isNaN(budgetAmount) || budgetAmount < 0) {
showMessage('Zadajte platnÃº sumu rozpoÄtu.', 'error');
return;
}
monthlyBudget[category] = budgetAmount;
showMessage('RozpoÄet bol uloÅ¾enÃ½!', 'success');

saveDataToLocalStorage();
renderAllUI();
}

function updateBudgetSummary() {
const totalAmountSpent = expenses.reduce((sum, expense) => sum + expense.amount, 0);
const remaining = monthlyIncome - totalAmountSpent;

document.getElementById('total-spent').textContent = `${totalAmountSpent.toFixed(2)} â‚¬`;

const remainingBudgetEl = document.getElementById('remaining-budget');
const remainingBudgetContainerEl = document.getElementById('remaining-budget-container');
remainingBudgetEl.textContent = `${remaining.toFixed(2)} â‚¬`;

remainingBudgetContainerEl.classList.remove('bg-green-100', 'bg-red-100', 'bg-yellow-100');
remainingBudgetEl.classList.remove('text-green-600', 'text-red-600', 'text-yellow-600');

if (remaining < 0) {
remainingBudgetContainerEl.classList.add('bg-red-100');
remainingBudgetEl.classList.add('text-red-600');
} else if (remaining < monthlyIncome * 0.1) {
remainingBudgetContainerEl.classList.add('bg-yellow-100');
remainingBudgetEl.classList.add('text-yellow-600');
} else {
remainingBudgetContainerEl.classList.add('bg-green-100');
remainingBudgetEl.classList.add('text-green-600');
}
}

function renderTable() {
const expenseTableBody = document.getElementById('expense-table-body');
expenseTableBody.innerHTML = '';

const sortedExpenses = [...expenses].sort((a, b) => new Date(b.date) - new Date(a.date));

if (sortedExpenses.length === 0) {
const noDataRow = document.createElement('tr');
noDataRow.innerHTML = `<td colspan="2" class="py-3 px-6 text-center text-gray-500">ZatiaÄ¾ Å¾iadne dÃ¡ta pre tento cyklus.</td>`;
expenseTableBody.appendChild(noDataRow);
return;
}

sortedExpenses.forEach(item => {
const row = document.createElement('tr');
row.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-100');
const date = new Date(item.date).toLocaleDateString('sk-SK');
row.innerHTML = `
<td class="py-3 px-6 text-left whitespace-nowrap">${date} - ${item.category}</td>
<td class="py-3 px-6 text-left text-red-600">-${item.amount.toFixed(2)} â‚¬</td>
`;
expenseTableBody.appendChild(row);
});
}

/**
 * Updated function to include Chart.js Data Labels plugin for percentage display on pie slices.
 */
function updateChart() {
const backgroundColors = [
'#EF4444', '#3B82F6', '#F59E0B', '#10B981', '#6366F1', '#EC4899', '#34D399', '#F97316', '#A78BFA', '#D946EF', '#4B5563', '#9CA3AF', '#CC33FF', '#FF6633', '#0099CC', '#99FF33'
];

const categoryTotals = expenses.reduce((acc, expense) => {
acc[expense.category] = (acc[expense.category] || 0) + expense.amount;
return acc;
}, {});

const labels = Object.keys(categoryTotals);
const data = Object.values(categoryTotals);
const totalAmount = data.reduce((sum, value) => sum + value, 0);

const legendContainer = document.getElementById('chart-legend');
legendContainer.innerHTML = '';
labels.forEach((label, index) => {
const legendItem = document.createElement('div');
legendItem.className = 'flex items-center space-x-2';
legendItem.innerHTML = `
<span class="w-4 h-4 rounded-full" style="background-color: ${backgroundColors[index % backgroundColors.length]};"></span>
<span>${label}: ${data[index].toFixed(2)} â‚¬</span>
`;
legendContainer.appendChild(legendItem);
});

if (pieChart) {
pieChart.destroy();
}

const ctx = document.getElementById('expense-pie-chart').getContext('2d');
pieChart = new Chart(ctx, {
type: 'pie',
data: {
labels: labels,
datasets: [{
data: data,
backgroundColor: backgroundColors,
borderColor: '#fff',
borderWidth: 2
}]
},
options: {
responsive: true,
plugins: {
legend: { display: false },
tooltip: {
callbacks: {
label: function(tooltipItem) {
const value = tooltipItem.raw;
const percentage = totalAmount > 0 ? ((value / totalAmount) * 100).toFixed(2) : 0;
return `${tooltipItem.label}: ${value.toFixed(2)} â‚¬ (${percentage}%)`;
}
}
},
// KonfigurÃ¡cia pre datovÃ© nÃ¡vesti (Data Labels)
datalabels: {
// FormÃ¡tovanie textu: KategÃ³ria + Percento
formatter: (value, context) => {
const total = context.dataset.data.reduce((a, b) => a + b, 0);
const percentage = (value / total * 100).toFixed(1) + "%";
return context.chart.data.labels[context.dataIndex] + '\n' + percentage;
},
color: '#fff', // Biela farba textu
font: {
weight: 'bold',
size: 10,
},
// Umiestnenie nÃ¡vestÃ­ uprostred vÃ½seku
anchor: 'center',
align: 'center',
},
}
},
// RegistrÃ¡cia pluginu pre sprÃ¡vne fungovanie
plugins: [ChartDataLabels] 
});
}

function updateBudgetRuleChart() {
    const budgetChartContainer = document.getElementById('budget-bar-chart-container');
    const budgetInfoContainer = document.getElementById('budget-info-container');
    const budgetSummaryEl = document.getElementById('budget-info');

    const budgetedCategories = Object.keys(monthlyBudget);
    if (budgetedCategories.length === 0) {
        if (budgetChart) budgetChart.destroy();
        if (budgetChartContainer) budgetChartContainer.classList.add('hidden');
        if (budgetInfoContainer) budgetInfoContainer.classList.add('hidden');
        return;
    }

    if (budgetChartContainer) budgetChartContainer.classList.remove('hidden');
    if (budgetInfoContainer) budgetInfoContainer.classList.remove('hidden');
    if (budgetSummaryEl) budgetSummaryEl.innerHTML = '';

    const spentData = budgetedCategories.map(cat => expenses.filter(e => e.category === cat).reduce((sum, e) => sum + e.amount, 0));
    const budgetData = budgetedCategories.map(cat => monthlyBudget[cat] || 0);

    if (budgetChart) {
        budgetChart.destroy();
    }

    const ctx = document.getElementById('budget-bar-chart').getContext('2d');
    budgetChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: budgetedCategories,
            datasets: [{
                label: 'RozpoÄet',
                data: budgetData,
                backgroundColor: 'rgba(75, 192, 192, 0.5)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }, {
                label: 'MinutÃ©',
                data: spentData,
                backgroundColor: spentData.map((spent, index) => spent > budgetData[index] ? 'rgba(255, 99, 132, 0.5)' : 'rgba(54, 162, 235, 0.5)'),
                borderColor: spentData.map((spent, index) => spent > budgetData[index] ? 'rgba(255, 99, 132, 1)' : 'rgba(54, 162, 235, 1)'),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Suma (â‚¬)'
                    }
                }
            }
        },
    });
}

function updateBudgetStatus() {
    const budgetStatusContainer = document.getElementById('budget-status-container');
    if (!budgetStatusContainer) return;
    
    budgetStatusContainer.innerHTML = '';
    const budgetedCategories = Object.keys(monthlyBudget);

    if (budgetedCategories.length === 0) {
        budgetStatusContainer.innerHTML = '<p class="text-gray-500 text-sm mt-2">ZatiaÄ¾ nemÃ¡te nastavenÃ½ Å¾iadny rozpoÄet.</p>';
        return;
    }

    budgetedCategories.forEach(category => {
        const budgetAmount = monthlyBudget[category];
        const spentAmount = expenses.filter(e => e.category === category).reduce((sum, e) => sum + e.amount, 0);
        const remaining = budgetAmount - spentAmount;
        const percentageUsed = budgetAmount > 0 ? (spentAmount / budgetAmount) * 100 : 0;

        let statusText = '';
        let statusColor = '';
        let progressBarColor = '';

        if (remaining < 0) {
            statusText = 'PrekroÄenÃ½ rozpoÄet';
            statusColor = 'text-red-600';
            progressBarColor = 'bg-red-500';
        } else if (percentageUsed >= 80) {
            statusText = 'BlÃ­Å¾i sa k limitu';
            statusColor = 'text-yellow-600';
            progressBarColor = 'bg-yellow-500';
        } else {
            statusText = 'V rÃ¡mci rozpoÄtu';
            statusColor = 'text-green-600';
            progressBarColor = 'bg-green-500';
        }
        
        const progressBarWidth = Math.min(percentageUsed, 100);

        const statusElement = document.createElement('div');
        statusElement.className = 'bg-white p-4 rounded-lg shadow-sm border border-gray-200';
        statusElement.innerHTML = `
            <div class="flex justify-between items-center mb-2">
                <span class="font-medium text-gray-700">${category}</span>
                <span class="font-bold text-sm ${statusColor}">${statusText}</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div class="h-2.5 rounded-full ${progressBarColor}" style="width: ${progressBarWidth}%;"></div>
            </div>
            <div class="flex justify-between text-xs mt-1 text-gray-500">
                <span>MinutÃ©: ${spentAmount.toFixed(2)} â‚¬</span>
                <span>RozpoÄet: ${budgetAmount.toFixed(2)} â‚¬</span>
            </div>
        `;
        budgetStatusContainer.appendChild(statusElement);
    });
}


async function handlePrintChartAndTable() {
    // Re-render charts to ensure they are up-to-date before capture
    updateChart();
    updateBudgetRuleChart();
    await new Promise(resolve => setTimeout(resolve, 500));

    const pieChartCanvas = document.getElementById('expense-pie-chart');
    const pieChartImage = pieChartCanvas ? pieChartCanvas.toDataURL('image/png', 1.0) : null;
    
    const budgetChartCanvas = document.getElementById('budget-bar-chart');
    const budgetChartImage = budgetChartCanvas ? budgetChartCanvas.toDataURL('image/png', 1.0) : null;
    
    const dataToPrint = {
        expenses: expenses,
        monthlyIncome: monthlyIncome,
        monthlyBudget: monthlyBudget,
        cycleStartDate: cycleStartDate
    };

    const cycleStartDateString = dataToPrint.cycleStartDate ? new Date(dataToPrint.cycleStartDate).toLocaleDateString('sk-SK') : 'N/A';
    const cycleEndDateString = new Date().toLocaleDateString('sk-SK');

    const tableRows = dataToPrint.expenses.length > 0
    ? dataToPrint.expenses.map(item => `
        <tr class="border-b border-gray-200">
            <td class="py-3 px-6 text-left whitespace-nowrap">${new Date(item.date).toLocaleDateString('sk-SK')} - ${item.category}</td>
            <td class="py-3 px-6 text-left text-red-600">-${item.amount.toFixed(2)} â‚¬</td>
        </tr>
    `).join('')
    : `<tr><td colspan="2" class="py-3 px-6 text-center text-gray-500">ZatiaÄ¾ Å¾iadne dÃ¡ta pre tento cyklus.</td></tr>`;

    const totalSpent = dataToPrint.expenses.reduce((sum, e) => sum + e.amount, 0);
    const remaining = dataToPrint.monthlyIncome - totalSpent;

    // ğŸ”¥ DOPLNENÃ‰ â€“ TOTO JE TO, ÄŒO TI CHÃBALO!
    const categoryTotals = dataToPrint.expenses.reduce((acc, item) => {
        acc[item.category] = (acc[item.category] || 0) + item.amount;
        return acc;
    }, {});

    const printContent = `
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
            body { 
                font-family: 'Inter', sans-serif;
                margin: 0;
                padding: 0;
                color: #1f2937;
            }
            .print-container {
                max-width: 800px;
                margin: 0 auto;
                padding: 2rem;
            }
            h1, h2 { color: #1e3a8a; }
            table { width: 100%; border-collapse: collapse; text-align: left; margin-top: 1rem; }
            th, td { border: 1px solid #d1d5db; padding: 0.75rem; }
            th { background-color: #e5e7eb; color: #4b5563; font-weight: bold; }
            .summary p { font-size: 1.2rem; margin-bottom: 0.5rem; }
            .summary .total { font-weight: bold; }
            .no-print { display: flex; gap: 0.5rem; position: fixed; top: 1rem; right: 1rem; left: 1rem; z-index: 1000; }
            .no-print button {
                background-color: #dc2626; color: #fff; font-weight: bold;
                padding: 0.75rem 1.5rem; border-radius: 0.5rem; border: none;
                cursor: pointer; display: flex; align-items: center; gap: 0.5rem;
            }
            .no-print button:hover { background-color: #991b1b; }
            @media print {
                .no-print { display: none; }
                .print-container { padding: 0.5rem !important; }
                .print-table { font-size: 0.7rem !important; }
                .summary { margin-top: 0.1rem !important; padding-top: 0.1rem !important; }
                .summary p { font-size: 0.7rem !important; margin-bottom: 0 !important; }
                .print-container .summary:last-child { margin-top: 0.1rem !important; padding-top: 0.1rem !important; }
            }
        </style>

        <div class="no-print">
            <button onclick="window.close()">SpÃ¤Å¥</button>
            <button onclick="window.print()">TlaÄiÅ¥</button>
        </div>

        <div class="print-container">
            <h1 style="text-align:center;font-size:2rem;margin-bottom:1rem;">PrehÄ¾ad rozpoÄtu</h1>
            <p style="text-align:center;color:#4b5563;">Cyklus od ${cycleStartDateString} do ${cycleEndDateString}</p>

            ${pieChartImage ? `
                <h2 style="margin-top:2rem;font-size:1.5rem;">Graf vÃ½davkov</h2>
                <img src="${pieChartImage}" style="max-width:100%; height:auto;">
            ` : ''}

            <h2 style="margin-top:2rem;font-size:1.5rem;">PodrobnÃ½ zoznam vÃ½davkov</h2>
            <table class="print-table">
                <thead>
                    <tr><th>DÃ¡tum a poloÅ¾ka</th><th>Suma (â‚¬)</th></tr>
                </thead>
                <tbody>${tableRows}</tbody>
            </table>

            ${budgetChartImage ? `
                <h2 style="margin-top:2rem;font-size:1.5rem;">RozpoÄtovÃ© kategÃ³rie</h2>
                <img src="${budgetChartImage}" style="max-width:100%; height:auto;">
            ` : ''}

            <div class="summary" style="margin-top:2rem;border-top:1px solid #d1d5db;padding-top:1rem;">
                <p>CelkovÃ½ prÃ­jem: <span class="total">${dataToPrint.monthlyIncome.toFixed(2)} â‚¬</span></p>
                <p>Minul som: <span class="total">${totalSpent.toFixed(2)} â‚¬</span></p>
                <p>ZostÃ¡va mi: <span class="total">${remaining.toFixed(2)} â‚¬</span></p>
            </div>

            <h2 style="margin-top:2rem;font-size:1.5rem;">SÃºhrn vÃ½davkov podÄ¾a kategÃ³rie</h2>
            <table class="print-table">
                <thead>
                    <tr><th>KategÃ³ria</th><th>Suma (â‚¬)</th></tr>
                </thead>
                <tbody>
                    ${Object.entries(categoryTotals).map(([category, amount]) => `
                        <tr>
                            <td>${category}</td>
                            <td>${amount.toFixed(2)} â‚¬</td>
                        </tr>
                    `).join('')}
                    <tr style="font-weight:bold;background:#e5e7eb;">
                        <td>CELKOM</td>
                        <td>${totalSpent.toFixed(2)} â‚¬</td>
                    </tr>
                </tbody>
            </table>
        </div>
    `;

    const printWindow = window.open('', '_blank', 'width=900,height=700');
    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.focus();
} // koniec funkcie handlePrintChartAndTable






function updateCycleDatesDisplay(start = cycleStartDate, end = null) {
const cycleDatesEl = document.getElementById('cycle-dates');
const startStr = start ? start.toLocaleDateString('sk-SK') : 'N/A';
const endStr = end ? end.toLocaleDateString('sk-SK') : 'N/A';

if (startStr && endStr) {
cycleDatesEl.textContent = `Cyklus od ${startStr} do ${endStr}.`;
} else if (startStr) {
cycleDatesEl.textContent = `Sledovanie rozpoÄtu od ${startStr}. Koniec cyklu zatiaÄ¾ nie je urÄenÃ½.`;
} else {
cycleDatesEl.textContent = `ZaÄnite pridÃ¡vanÃ­m vÃ½davkov alebo prÃ­jmov, aby sa spustil cyklus.`;
}
}

/**
 * Renders dropdowns and manages the visibility of the custom category input.
 */
function renderUI() {
    const allCategories = getAllCategories();
    const categorySelect = document.getElementById('expense-category');
    const budgetCategorySelect = document.getElementById('budget-category-select');
    const customInputGroup = document.getElementById('custom-category-input-group');
    
    // --- Render Expense Category Dropdown ---
    
    // UloÅ¾Ã­me aktuÃ¡lne vybranÃº hodnotu
    const currentExpenseSelection = categorySelect.value;
    categorySelect.innerHTML = '';
    
    // PridÃ¡me vÅ¡etky kategÃ³rie (vopred definovanÃ© + vlastnÃ©)
    allCategories.forEach(category => {
        categorySelect.innerHTML += `<option value="${category}">${category}</option>`;
    });

    // PridÃ¡me moÅ¾nosÅ¥ pre vlastnÃº poloÅ¾ku na koniec
    categorySelect.innerHTML += `<option value="${CUSTOM_CATEGORY_OPTION}" class="font-bold border-t">-- VlastnÃ¡ poloÅ¾ka --</option>`;

    // ObnovÃ­me predoÅ¡lÃº voÄ¾bu, ak existuje, inak zvolÃ­me prvÃº
    if (currentExpenseSelection && allCategories.includes(currentExpenseSelection)) {
        categorySelect.value = currentExpenseSelection;
    } else if (currentExpenseSelection === CUSTOM_CATEGORY_OPTION) {
         categorySelect.value = CUSTOM_CATEGORY_OPTION;
    } else if (allCategories.length > 0) {
        categorySelect.value = allCategories[0];
    }
    
    // Nastavenie viditeÄ¾nosti pre vlastnÃº poloÅ¾ku pri spustenÃ­
    if (categorySelect.value === CUSTOM_CATEGORY_OPTION) {
        customInputGroup.classList.remove('hidden');
    } else {
        customInputGroup.classList.add('hidden');
    }


    // --- Render Budget Category Dropdown ---
    // RozpoÄet sa nastavuje len na EXISTUJÃšCE kategÃ³rie (vrÃ¡tane vlastnÃ½ch)
    const currentBudgetSelection = budgetCategorySelect.value;
    budgetCategorySelect.innerHTML = '';

    allCategories.forEach(category => {
        budgetCategorySelect.innerHTML += `<option value="${category}">${category}</option>`;
    });
    
    if (allCategories.length > 0) {
        if (currentBudgetSelection && allCategories.includes(currentBudgetSelection)) {
            budgetCategorySelect.value = currentBudgetSelection;
        } else {
            budgetCategorySelect.value = allCategories[0];
        }
    } else {
        // Ak nie sÃº Å¾iadne vÃ½davky a kategÃ³rie, zobraz aspoÅˆ predvolenÃ©
        expenseCategories.forEach(category => {
             budgetCategorySelect.innerHTML += `<option value="${category}">${category}</option>`;
        });
         budgetCategorySelect.value = expenseCategories[0];
    }
    
    // Nastavenie hodnoty inputu pre rozpoÄet
    const initialBudgetCategory = budgetCategorySelect.value;
    document.getElementById('budget-amount-input').value = monthlyBudget[initialBudgetCategory] || '';
}

// InicializÃ¡cia listenerov, ktorÃ© zÃ¡visia len na DOM (nebudÃº sa meniÅ¥ pri renderUI)
document.addEventListener('DOMContentLoaded', () => {
loadDataFromLocalStorage();

// InicializÃ¡cia a prvÃ© vykreslenie (volÃ¡ renderUI)
renderAllUI();

// Event listener pre zmenu v kategÃ³rii vÃ½davkov (ukÃ¡Å¾e/skryje pole pre vlastnÃº poloÅ¾ku)
document.getElementById('expense-category').addEventListener('change', (e) => {
    const customInputGroup = document.getElementById('custom-category-input-group');
    if (e.target.value === CUSTOM_CATEGORY_OPTION) {
        customInputGroup.classList.remove('hidden');
    } else {
        customInputGroup.classList.add('hidden');
    }
});

// Event listener pre zmenu v kategÃ³rii rozpoÄtu
document.getElementById('budget-category-select').addEventListener('change', (e) => {
    const selectedCategory = e.target.value;
    document.getElementById('budget-amount-input').value = monthlyBudget[selectedCategory] || '';
    updateBudgetRuleChart();
});


document.getElementById('add-expense-btn').addEventListener('click', handleAddExpense);
document.getElementById('save-income-btn').addEventListener('click', handleSaveIncome);
document.getElementById('save-budget-btn').addEventListener('click', handleSaveBudget);
document.getElementById('delete-current-cycle-btn').addEventListener('click', handleDeleteCurrentCycle);
document.getElementById('print-all-btn').addEventListener('click', handlePrintChartAndTable);

document.getElementById('start-new-cycle-btn').addEventListener('click', startNewCycle);

const historySidebar = document.getElementById('history-sidebar');
document.getElementById('view-history-btn').addEventListener('click', () => {
renderHistorySidebar();
historySidebar.classList.remove('translate-x-full');
});
document.getElementById('close-history-btn').addEventListener('click', () => {
historySidebar.classList.add('translate-x-full');
});
document.getElementById('back-to-current-btn').addEventListener('click', backToCurrentCycle);
document.getElementById('delete-history-btn').addEventListener('click', handleDeleteHistory);
});

</script>
</body>
</html>













