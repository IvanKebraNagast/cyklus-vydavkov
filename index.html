<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sledovanie výdavkov</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
body {
    font-family: 'Inter', sans-serif;
}
.modal {
    background-color: rgba(0, 0, 0, 0.5);
    transition: opacity 0.3s ease-in-out;
}
.modal-content {
    animation: fadeInScale 0.3s ease-in-out forwards;
}
.sidebar {
    transition: transform 0.3s ease-in-out;
}
@keyframes fadeInScale {
    from { opacity: 0; transform: scale(0.95);}
    to { opacity: 1; transform: scale(1);}
}
@media print {
    .no-print { display: none !important; }
    .print-area {
        display: block !important;
        position: static;
        width: 100%; height: auto;
    }
}
</style>
</head>

<body class="bg-gray-100 flex min-h-screen p-4">

<div id="main-content" class="container mx-auto bg-white shadow-xl rounded-2xl p-8 space-y-8 max-w-4xl">

<header class="text-center">
<h1 class="text-4xl font-bold text-blue-900 mb-2">Sledovanie výdavkov</h1>
<div class="inline-block px-4 py-1.5 bg-gray-200 rounded-full text-gray-700 text-sm font-medium">
Vytvoril: IvanKebraNagast
</div>
<p id="cycle-dates" class="text-gray-600">Sledovanie rozpočtu.</p>
</header>
 <!-- Sekcia pre správu cyklov -->
<section class="bg-gray-50 p-6 rounded-xl border border-gray-200 flex flex-col md:flex-row items-center justify-between gap-4 no-print">
<h2 class="text-xl font-bold text-gray-800">Správa cyklov</h2>
<div class="flex gap-4 w-full md:w-auto">
<button id="start-new-cycle-btn" class="flex-1 px-6 py-2.5 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700">
Ukončiť aktuálny cyklus a začať nový
</button>
<button id="view-history-btn" class="flex-1 px-6 py-2.5 bg-gray-600 text-white font-bold rounded-lg shadow-md hover:bg-gray-700">
Zobraziť históriu
</button>
</div>
</section>

<!-- Zjednotená sekcia formulárov -->
<div id="current-cycle-forms">

<section class="bg-gray-50 p-6 rounded-xl border border-gray-200 grid grid-cols-1 md:grid-cols-3 gap-4 no-print">

<div class="flex flex-col items-start space-y-2">
<label class="text-sm font-medium text-gray-700">Celkový príjem (€)</label>
<input type="number" id="monthly-income-input" placeholder="0.00" step="0.01"
class="w-full px-4 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
<button id="save-income-btn"
class="w-full px-6 py-2.5 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700">
Uložiť príjem
</button>
</div>

<div class="flex flex-col items-center justify-center bg-blue-100 p-4 rounded-lg">
<span class="text-sm font-medium text-blue-800">Minul som</span>
<span id="total-spent" class="text-2xl font-bold text-blue-600 mt-1">0.00 €</span>
</div>

<div id="remaining-budget-container" class="flex flex-col items-center justify-center p-4 rounded-lg">
<span class="text-sm font-medium text-green-800">Zostáva mi</span>
<span id="remaining-budget" class="text-2xl font-bold mt-1">0.00 €</span>
</div>

</section>

<!-- Sekcia rozpočtu -->
<section class="bg-gray-50 p-6 rounded-xl border border-gray-200 no-print">
<h2 class="text-2xl font-bold text-gray-800 mb-4">Rozpočtové pravidlo</h2>

<div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">

<div>
<label class="block text-sm text-gray-700 mb-1">Položka pre rozpočet</label>
<select id="budget-category-select"
class="w-full px-4 py-2 border rounded-lg focus:ring-blue-500 bg-white"></select>
</div>

<div>
<label class="block text-sm text-gray-700 mb-1">Rozpočet (€)</label>
<input type="number" id="budget-amount-input" placeholder="100.00" step="0.01"
class="w-full px-4 py-2 border rounded-lg focus:ring-blue-500">
</div>

<button id="save-budget-btn"
class="w-full px-6 py-2.5 bg-yellow-600 text-white font-bold rounded-lg shadow-md hover:bg-yellow-700">
Uložiť rozpočet
</button>

</div>

<div id="budget-bar-chart-container"
class="relative w-full max-w-2xl mx-auto mt-6 hidden">
<canvas id="budget-bar-chart"></canvas>
</div>

<div id="budget-status-container" class="mt-6 space-y-4"></div>
</section>

<!-- Pridanie výdavku -->
<section class="bg-gray-50 p-6 rounded-xl border border-gray-200 no-print">
<h2 class="text-2xl font-bold text-gray-800 mb-4">Pridať nový výdavok</h2>

<div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">

<div id="expense-category-container">
<label class="block text-sm text-gray-700 mb-1">Položka</label>
<select id="expense-category"
class="w-full px-4 py-2 border rounded-lg bg-white"></select>
</div>

<div id="custom-category-input-group" class="hidden">
<label class="block text-sm text-gray-700 mb-1">Vlastná položka</label>
<input type="text" id="custom-category-input" placeholder="Napr. Darček pre Petra"
class="w-full px-4 py-2 border rounded-lg focus:ring-blue-500">
</div>

<div>
<label class="block text-sm text-gray-700 mb-1">Suma (€)</label>
<input type="number" id="expense-amount" placeholder="50.00" step="0.01"
class="w-full px-4 py-2 border rounded-lg focus:ring-blue-500">
</div>

<button id="add-expense-btn"
class="w-full px-6 py-2.5 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700">
Pridať
</button>

</div>
</section>

</div> <!-- end current-cycle-forms -->

<!-- Správa historického režimu -->
<div id="history-view-message" class="hidden bg-gray-200 p-6 rounded-xl text-center">
<p class="text-xl font-bold text-gray-700">Momentálne prezeráte historický cyklus.</p>
<p class="text-sm text-gray-600 mt-2">Dáta sú len na čítanie.</p>
</div>
<!-- HLAVNÁ SEKCIA -->
<section class="flex flex-col lg:flex-row gap-8">

<!-- ĽAVÁ STRANA – PIE GRAF + LEGENDA + SÚHRN -->
<div class="flex-1 bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-sm">

<h2 class="text-2xl font-bold text-gray-800 mb-4">Graf výdavkov</h2>

<div class="relative w-full max-w-sm mx-auto">
<canvas id="expense-pie-chart"></canvas>

<div id="chart-legend"
class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-2 text-sm text-gray-700"></div>
</div>

<div id="summary-table-container" class="mt-8">
<h3 class="text-xl font-bold text-gray-800 mb-2">Súhrn výdavkov podľa kategórie</h3>

<table class="min-w-full border border-gray-300 text-left">
<thead>
<tr class="bg-gray-200 text-gray-700 text-sm uppercase">
<th class="py-2 px-4">Kategória</th>
<th class="py-2 px-4">Suma (€)</th>
</tr>
</thead>
<tbody id="summary-table-body"></tbody>
</table>
</div>
</div>

<!-- PRAVÁ STRANA – TABUĽKA VÝDAVKOV -->
<div class="flex-1 bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-sm overflow-x-auto">

<h2 class="text-2xl font-bold text-gray-800 mb-4">Prehľad výdavkov</h2>

<table class="min-w-full table-auto text-center">
<thead>
<tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
<th class="py-3 px-6 text-left">Dátum a položka</th>
<th class="py-3 px-6 text-left">Suma (€)</th>
</tr>
</thead>
<tbody id="expense-table-body" class="text-gray-700 text-sm font-light"></tbody>
</table>

<button id="delete-current-cycle-btn"
class="mt-4 w-full px-6 py-2.5 bg-red-600 text-white font-bold rounded-lg shadow-md hover:bg-red-700 no-print">
Vymazať dáta aktuálneho cyklu
</button>

</div>

</section>

<!-- DRUHÁ SEKCIA ROZPOČTU DOLE – ZOSTÁVA -->
<section class="bg-gray-50 p-6 rounded-xl border border-gray-200 mt-8 shadow-sm">

<h2 class="text-2xl font-bold text-gray-800 mb-4">Rozpočtové pravidlo</h2>

<div id="budget-bar-chart-container" class="relative w-full max-w-2xl mx-auto mt-6 hidden">
<canvas id="budget-bar-chart"></canvas>
</div>

<div id="budget-status-container" class="mt-6 space-y-4"></div>
</section>

<!-- ĎALŠIA TABUĽKA (TVOJA DUPLIKOVANÁ) – NECHÁM LEN JEDNU VERZIU -->
<div class="flex-1 bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-sm overflow-x-auto flex flex-col">

<h2 class="text-2xl font-bold text-gray-800 mb-4">Prehľad výdavkov</h2>

<div class="table-container">
<table class="min-w-full table-auto text-center">
<thead>
<tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
<th class="py-3 px-6 text-left">Dátum a položka</th>
<th class="py-3 px-6 text-left">Suma (€)</th>
</tr>
</thead>
<tbody id="expense-table-body"></tbody>
</table>
</div>

<button id="delete-current-cycle-btn"
class="mt-4 w-full px-6 py-2.5 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 no-print">
Vymazať dáta aktuálneho cyklu
</button>

</div>

<!-- TLAČIDLO TLAČE -->
<section class="mt-4 flex justify-center no-print">
<button id="print-all-btn"
class="flex items-center gap-2 px-6 py-2.5 bg-gray-600 text-white font-bold rounded-lg shadow-md hover:bg-gray-700">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"
style="width:1rem;height:1rem;fill:currentColor;">
<path d="M128 0C92.7 0 64 28.7 64 64v96h64V64c0-17.7 14.3-32 32-32H352c17.7 0 32 14.3 32 32v96h64V64c0-35.3-28.7-64-64-64H128zM0 192c0-35.3 28.7-64 64-64H448c35.3 0 64 28.7 64 64v32V416c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V224 192zm64 64V416H448V256H64zM200 352h112c4.4 0 8-3.6 8-8c0-4.4-3.6-8-8-8H200c-4.4 0-8 3.6-8 8c0 4.4 3.6 8 8 8z"/>
</svg>
Tlačiť
</button>
</section>

<!-- NOTIFIKÁCIA -->
<div id="message-box"
class="fixed bottom-4 left-1/2 -translate-x-1/2 p-4 rounded-xl shadow-lg hidden no-print">
<p id="message-text" class="font-medium text-white"></p>
</div>

<!-- CONFIRMATION DIALOG -->
<div id="confirmation-dialog"
class="modal fixed inset-0 flex items-center justify-center p-4 z-50 hidden no-print">
<div class="modal-content bg-white rounded-xl shadow-2xl p-8 max-w-sm mx-auto space-y-6">
<h3 class="text-2xl font-bold text-gray-800">Potvrdenie</h3>
<p id="confirmation-message" class="text-gray-700"></p>

<div class="flex justify-end gap-4">
<button id="cancel-btn" class="px-6 py-2.5 bg-gray-300 text-gray-800 font-bold rounded-lg hover:bg-gray-400">
Zrušiť
</button>
<button id="confirm-btn" class="px-6 py-2.5 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700">
Potvrdiť
</button>
</div>

</div>
</div>

<!-- BOČNÝ PANEL HISTÓRIE -->
<div id="history-sidebar"
class="sidebar fixed top-0 right-0 h-full w-80 bg-gray-900 text-white p-6 translate-x-full z-40 shadow-lg overflow-y-auto no-print">

<div class="flex justify-between items-center mb-6">
<h2 class="text-2xl font-bold">História cyklov</h2>
<button id="close-history-btn" class="text-2xl font-bold hover:text-gray-400">×</button>
</div>

<div id="history-list" class="space-y-4"></div>

<button id="delete-history-btn"
class="mt-4 w-full px-6 py-2.5 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700">
Vymazať celú históriu
</button>

<button id="back-to-current-btn"
class="mt-4 w-full px-6 py-2.5 bg-gray-500 text-white font-bold rounded-lg hover:bg-gray-600">
Späť na aktuálny cyklus
</button>

</div>

<div class="print-area"></div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

<script>
// ----------------------------
// GLOBÁLNE PREMENNÉ
// ----------------------------
let expenses = [];
let monthlyIncome = 0;
let monthlyBudget = {};
let cycleStartDate = null;

let pieChart = null;
let budgetChart = null;

let isHistoryView = false;

const currentCycleKey = "expenseTrackerData-current";
const archiveKeyPrefix = "expenseTrackerData-archived-";

const CUSTOM_CATEGORY_OPTION = "CUSTOM_CATEGORY_INPUT";

let expenseCategories = [
    "Nájomné","Internet","Elektrika","Kúrenie","Poistka za auto",
    "Poistenie zodpovednosti za byt","Potraviny","Doprava",
    "Zábava","Cigarety","Alkohol","Ostatné"
];


// ----------------------------------------------------
// ULOŽENIE A NAČÍTANIE
// ----------------------------------------------------
function saveDataToLocalStorage(key = currentCycleKey) {
    const data = {
        expenses,
        monthlyIncome,
        monthlyBudget,
        cycleStartDate: cycleStartDate ? cycleStartDate.toISOString() : null
    };
    localStorage.setItem(key, JSON.stringify(data));
}

function loadDataFromLocalStorage(key = currentCycleKey) {
    const data = JSON.parse(localStorage.getItem(key));

    if (data) {
        expenses = data.expenses || [];
        monthlyIncome = data.monthlyIncome || 0;
        monthlyBudget = data.monthlyBudget || {};
        cycleStartDate = data.cycleStartDate ? new Date(data.cycleStartDate) : null;
    } else {
        expenses = [];
        monthlyIncome = 0;
        monthlyBudget = {};
        cycleStartDate = null;
    }
}


// ----------------------------------------------------
// POMOCNÉ FUNKCIE
// ----------------------------------------------------
function getAllCategories() {
    let all = new Set(expenseCategories);
    expenses.forEach(x => all.add(x.category));
    Object.keys(monthlyBudget).forEach(x => all.add(x));
    return [...all].sort();
}

function showMessage(text, type="success") {
    const el = document.getElementById("message-box");
    const txt = document.getElementById("message-text");

    el.classList.remove("hidden","bg-red-500","bg-green-500","bg-blue-500");

    txt.textContent = text;
    el.classList.add(
        type === "error" ? "bg-red-500" :
        type === "info"  ? "bg-blue-500" :
                           "bg-green-500"
    );

    setTimeout(()=>el.classList.add("hidden"),3000);
}

function showConfirmationDialog(text, onConfirm) {
    const dialog = document.getElementById("confirmation-dialog");
    const msg = document.getElementById("confirmation-message");
    msg.textContent = text;

    dialog.classList.remove("hidden");

    function close() {
        dialog.classList.add("hidden");
        c.removeEventListener("click", confirm);
        x.removeEventListener("click", cancel);
    }

    const c = document.getElementById("confirm-btn");
    const x = document.getElementById("cancel-btn");

    function confirm(){ onConfirm(); close(); }
    function cancel(){ close(); }

    c.addEventListener("click", confirm);
    x.addEventListener("click", cancel);
}


// ----------------------------------------------------
// RENDER UI HLAVNÝ
// ----------------------------------------------------
function renderUI() {
    const all = getAllCategories();

    // dropdown výdavkov
    const sel = document.getElementById("expense-category");
    const custom = document.getElementById("custom-category-input-group");

    let last = sel.value;
    sel.innerHTML = "";

    all.forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`);
    sel.innerHTML += `<option value="${CUSTOM_CATEGORY_OPTION}">-- Vlastná položka --</option>`;

    if (last && (all.includes(last) || last === CUSTOM_CATEGORY_OPTION)) sel.value = last;

    custom.classList.toggle("hidden", sel.value !== CUSTOM_CATEGORY_OPTION);

    // dropdown rozpočtu
    const bsel = document.getElementById("budget-category-select");
    let lastB = bsel.value;

    bsel.innerHTML = "";
    all.forEach(c => bsel.innerHTML += `<option value="${c}">${c}</option>`);

    if (lastB && all.includes(lastB)) bsel.value = lastB;
    else if (all.length) bsel.value = all[0];
}


// ----------------------------------------------------
// RENDER TABUĽKY
// ----------------------------------------------------
function renderTable() {
    const tbody = document.getElementById("expense-table-body");
    tbody.innerHTML = "";

    if (expenses.length === 0) {
        tbody.innerHTML = `<tr><td colspan="2" class="py-3 text-center text-gray-500">Žiadne dáta.</td></tr>`;
        return;
    }

    [...expenses]
        .sort((a,b)=> new Date(b.date)-new Date(a.date))
        .forEach(e=>{
            tbody.innerHTML += `
                <tr class="border-b border-gray-300">
                    <td class="py-3 px-6">${new Date(e.date).toLocaleDateString("sk-SK")} – ${e.category}</td>
                    <td class="py-3 px-6 text-red-600">-${e.amount.toFixed(2)} €</td>
                </tr>
            `;
        });
}


// ----------------------------------------------------
// PIE CHART
// ----------------------------------------------------
function updateChart() {
    const ctx = document.getElementById("expense-pie-chart");
    if (!ctx) return;

    const totals = expenses.reduce((a,x)=>{
        a[x.category] = (a[x.category]||0)+x.amount;
        return a;
    },{});

    const labels = Object.keys(totals);
    const data   = Object.values(totals);

    if (pieChart) pieChart.destroy();

    pieChart = new Chart(ctx,{
        type:"pie",
        data:{
            labels,
            datasets:[{
                data,
                backgroundColor:[
                    "#EF4444","#3B82F6","#F59E0B","#10B981","#6366F1","#EC4899",
                    "#34D399","#F97316","#A78BFA","#D946EF","#4B5563","#9CA3AF"
                ]
            }]
        },
        options:{
            plugins:{
                legend:{display:false},
                datalabels:{
                    color:"#fff",
                    formatter:(v, ctx)=>{
                        let sum = ctx.dataset.data.reduce((a,b)=>a+b,0);
                        return ((v/sum)*100).toFixed(1)+"%";
                    }
                }
            }
        },
        plugins:[ChartDataLabels]
    });

    // legenda
    const legend = document.getElementById("chart-legend");
    legend.innerHTML = "";
    labels.forEach((lab,i)=>{
        legend.innerHTML += `
            <div class="flex items-center gap-2">
                <span class="w-4 h-4 rounded-full" style="background:${pieChart.data.datasets[0].backgroundColor[i]}"></span>
                <span>${lab}: ${data[i].toFixed(2)} €</span>
            </div>`;
    });
}


// ----------------------------------------------------
// PRINT FUNKCIA – OPRAVENÁ KOMPLETNE
// ----------------------------------------------------
async function handlePrintChartAndTable() {

    updateChart();
    await new Promise(r=>setTimeout(r,300));

    const pieImg = document.getElementById("expense-pie-chart").toDataURL();

    const totals = expenses.reduce((a,x)=>{
        a[x.category]=(a[x.category]||0)+x.amount;
        return a;
    },{});

    const totalSpent = Object.values(totals).reduce((a,b)=>a+b,0);
    const remaining = monthlyIncome - totalSpent;

    const rows = expenses.map(e=>`
        <tr>
            <td>${new Date(e.date).toLocaleDateString("sk-SK")} – ${e.category}</td>
            <td>-${e.amount.toFixed(2)} €</td>
        </tr>
    `).join("");

    const summary = Object.entries(totals).map(([cat,val])=>`
        <tr><td>${cat}</td><td>${val.toFixed(2)} €</td></tr>
    `).join("");

    const printHTML = `
        <h1>Prehľad rozpočtu</h1>
        <p>Od: ${cycleStartDate ? cycleStartDate.toLocaleDateString("sk-SK") : "N/A"}
           Do: ${new Date().toLocaleDateString("sk-SK")}</p>

        <img src="${pieImg}" style="width:300px;margin:20px 0">

        <h2>Výdavky</h2>
        <table border="1" cellspacing="0" cellpadding="6">
            <tr><th>Dátum a položka</th><th>Suma</th></tr>
            ${rows}
        </table>

        <h2>Súhrn kategórií</h2>
        <table border="1" cellspacing="0" cellpadding="6">
            <tr><th>Kategória</th><th>Suma</th></tr>
            ${summary}
            <tr><td><b>CELKOM</b></td><td><b>${totalSpent.toFixed(2)} €</b></td></tr>
        </table>

        <h2>Zostáva</h2>
        <p>Príjem: ${monthlyIncome.toFixed(2)} €</p>
        <p>Minuté: ${totalSpent.toFixed(2)} €</p>
        <p>Zostáva: ${remaining.toFixed(2)} €</p>
    `;

    const w = window.open("", "_blank");
    w.document.write(printHTML);
    w.document.close();
}


// ----------------------------------------------------
// PRIDANIE VÝDAVKU
// ----------------------------------------------------
function handleAddExpense() {
    let amount = parseFloat(document.getElementById("expense-amount").value);
    if (isNaN(amount) || amount<=0) return showMessage("Zadaj platnú sumu","error");

    let cat = document.getElementById("expense-category").value;
    if (cat === CUSTOM_CATEGORY_OPTION) {
        cat = document.getElementById("custom-category-input").value.trim();
        if (!cat) return showMessage("Zadaj názov položky","error");
    }

    expenses.push({
        date:new Date().toISOString(),
        category:cat,
        amount
    });

    saveDataToLocalStorage();
    renderAllUI();
    showMessage("Výdavok pridaný");
}


// ----------------------------------------------------
// RENDER VŠETKÉHO
// ----------------------------------------------------
function renderAllUI() {
    renderUI();
    renderTable();
    updateChart();
}


// ----------------------------------------------------
// DOM READY
// ----------------------------------------------------
document.addEventListener("DOMContentLoaded",()=>{

    loadDataFromLocalStorage();
    renderAllUI();

    document.getElementById("add-expense-btn")
        .addEventListener("click", handleAddExpense);

    document.getElementById("print-all-btn")
        .addEventListener("click", handlePrintChartAndTable);

    document.getElementById("expense-category")
        .addEventListener("change",(e)=>{
            document.getElementById("custom-category-input-group")
                .classList.toggle("hidden",e.target.value!==CUSTOM_CATEGORY_OPTION);
        });
});
</script>

</body>
</html>
  
