<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Sledovanie výdavkov</title>

<!-- PWA -->
<link rel="manifest" href="/cyklus-vydavkov/manifest.webmanifest">
<meta name="theme-color" content="#ffffff">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Sledovanie výdavkov">
<link rel="apple-touch-icon" href="/cyklus-vydavkov/icon.png">

<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
body { font-family: 'Inter', sans-serif; }
.modal { background-color: rgba(0, 0, 0, 0.5); transition: opacity 0.3s ease-in-out; }
.modal-content { animation: fadeInScale 0.3s ease-in-out forwards; }
.sidebar { transition: transform 0.3s ease-in-out; }
@keyframes fadeInScale { from { opacity: 0; transform: scale(0.95);} to { opacity: 1; transform: scale(1);} }

@media print {
  .no-print { display: none !important; }
  body, html { height: auto; overflow: visible; margin: 0; padding: 0; }
}
</style>

</head>
<body class="bg-gray-100 flex min-h-screen p-4">

<div id="main-content" class="container mx-auto bg-white shadow-xl rounded-2xl p-8 space-y-8 max-w-4xl">

<header class="text-center">
  <h1 class="text-4xl font-bold text-blue-900 mb-2">Sledovanie výdavkov</h1>
  <div class="inline-block px-4 py-1.5 bg-gray-200 rounded-full text-gray-700 text-sm font-medium">
    Vytvoril: IvanKebraNagast
  </div>
  <p id="cycle-dates" class="text-gray-600">
    Sledovanie rozpočtu.
  </p>
</header>

<section class="bg-gray-50 p-6 rounded-xl border border-gray-200 flex flex-col md:flex-row items-center justify-between gap-4 no-print">
  <h2 class="text-xl font-bold text-gray-800">Správa cyklov</h2>
  <div class="flex gap-4 w-full md:w-auto">
    <button id="start-new-cycle-btn" class="flex-1 px-6 py-2.5 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700">
      Ukončiť aktuálny cyklus a začať nový
    </button>
    <button id="view-history-btn" class="flex-1 px-6 py-2.5 bg-gray-600 text-white font-bold rounded-lg shadow-md hover:bg-gray-700">
      Zobraziť históriu
    </button>
  </div>
</section>

<div id="current-cycle-forms">

<section class="bg-gray-50 p-6 rounded-xl border border-gray-200 grid grid-cols-1 md:grid-cols-3 gap-4 no-print">
  <div class="flex flex-col items-start space-y-2">
    <label class="text-sm font-medium text-gray-700">Celkový príjem (€)</label>
    <input type="number" id="monthly-income-input" step="0.01" class="w-full px-4 py-2 border rounded-lg">
    <button id="save-income-btn" class="w-full px-6 py-2.5 bg-green-600 text-white font-bold rounded-lg">Uložiť príjem</button>
  </div>

  <div class="flex flex-col items-center justify-center bg-blue-100 p-4 rounded-lg">
    <span class="text-sm font-medium text-blue-800">Minul som</span>
    <span id="total-spent" class="text-2xl font-bold text-blue-600 mt-1">0.00 €</span>
  </div>

  <div id="remaining-budget-container" class="flex flex-col items-center justify-center p-4 rounded-lg">
    <span class="text-sm font-medium text-green-800">Zostáva</span>
    <span id="remaining-budget" class="text-2xl font-bold mt-1">0.00 €</span>
  </div>
</section>

<!-- ROZPOČTOVÉ PRAVIDLO -->
<section class="bg-gray-50 p-6 rounded-xl border border-gray-200 no-print">
  <h2 class="text-2xl font-bold text-gray-800 mb-4">Rozpočtové pravidlo</h2>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">

    <div>
      <label class="block text-sm text-gray-700 mb-1">Položka v rozpočte</label>
      <select id="budget-category-select" class="w-full px-4 py-2 border rounded-lg bg-white"></select>
    </div>

    <div>
      <label class="block text-sm text-gray-700 mb-1">Rozpočet (€)</label>
      <input type="number" id="budget-amount-input" step="0.01" placeholder="100.00" class="w-full px-4 py-2 border rounded-lg">
    </div>

    <button id="save-budget-btn" class="w-full px-6 py-2.5 bg-yellow-600 text-white font-bold rounded-lg">Uložiť</button>

  </div>

  <div id="budget-bar-chart-container" class="relative w-full max-w-2xl mx-auto mt-6 hidden">
    <canvas id="budget-bar-chart"></canvas>
  </div>

  <div id="budget-status-container" class="mt-6 space-y-4"></div>

</section>

<!-- PRIDAŤ NOVÝ VÝDAVOK -->
<section class="bg-gray-50 p-6 rounded-xl border border-gray-200 no-print">
  <h2 class="text-2xl font-bold text-gray-800 mb-4">Pridať nový výdavok</h2>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">

    <div>
      <label class="block text-sm text-gray-700 mb-1">Položka</label>
      <select id="expense-category" class="w-full px-4 py-2 border rounded-lg bg-white"></select>
    </div>

    <div id="custom-category-box" class="hidden">
      <label class="block text-sm text-gray-700 mb-1">Vlastná položka</label>
      <input id="custom-category-input" type="text" placeholder="Napr. Drogéria" class="w-full px-4 py-2 border rounded-lg">
    </div>

    <div>
      <label class="block text-sm text-gray-700 mb-1">Suma (€)</label>
      <input type="number" id="expense-amount" step="0.01" placeholder="50.00" class="w-full px-4 py-2 border rounded-lg">
    </div>

    <button id="add-expense-btn" class="w-full px-6 py-2.5 bg-blue-600 text-white font-bold rounded-lg">
      Pridať
    </button>

  </div>
</section>

</div>

<!-- HISTÓRIA -->
<div id="history-view-message" class="hidden bg-gray-200 p-6 rounded-xl text-center">
  <p class="text-xl font-bold text-gray-700">Prezeráte historický cyklus</p>
</div>

<section class="flex flex-col lg:flex-row gap-8">
  <div id="pie-chart-section" class="flex-1 bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-sm flex flex-col items-center">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">Graf výdavkov</h2>
    <div class="relative w-full max-w-sm flex flex-col items-center">
      <canvas id="expense-pie-chart"></canvas>
      <div id="chart-legend" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-2 text-sm text-gray-700"></div>

      <div id="chart-summary" class="mt-6 text-sm text-gray-800 font-medium w-full"></div>
    </div>
  </div>

  <div class="flex-1 bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-sm overflow-x-auto">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">Prehľad výdavkov</h2>
    <table class="min-w-full table-auto text-center">
      <thead>
        <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
          <th class="py-3 px-6 text-left">Dátum a položka</th>
          <th class="py-3 px-6 text-left">Suma (€)</th>
        </tr>
      </thead>
      <tbody id="expense-table-body" class="text-gray-700 text-sm font-light"></tbody>
    </table>

    <button id="delete-current-cycle-btn" class="mt-4 w-full px-6 py-2.5 bg-red-600 text-white font-bold rounded-lg no-print">
      Vymazať dáta aktuálneho cyklu
    </button>
  </div>
</section>

<section class="mt-4 flex justify-center">
  <button id="print-all-btn" class="flex items-center gap-2 px-6 py-2.5 bg-gray-600 text-white font-bold rounded-lg no-print">
    Tlačiť
  </button>
</section>

<div id="message-box" class="fixed bottom-4 left-1/2 -translate-x-1/2 p-4 rounded-xl shadow-lg hidden no-print">
  <p id="message-text" class="font-medium text-white"></p>
</div>

<div id="confirmation-dialog" class="modal fixed inset-0 flex items-center justify-center p-4 z-50 hidden no-print">
  <div class="modal-content bg-white rounded-xl shadow-2xl p-8 max-w-sm mx-auto space-y-6">
    <h3 class="text-2xl font-bold text-gray-800">Potvrdenie</h3>
    <p id="confirmation-message" class="text-gray-700"></p>
    <div class="flex justify-end gap-4">
      <button id="cancel-btn" class="px-6 py-2.5 bg-gray-300 text-gray-800 font-bold rounded-lg">Zrušiť</button>
      <button id="confirm-btn" class="px-6 py-2.5 bg-red-600 text-white font-bold rounded-lg">Potvrdiť</button>
    </div>
  </div>
</div>

<div id="history-sidebar" class="sidebar fixed top-0 right-0 h-full w-80 bg-gray-900 text-white p-6 transform translate-x-full z-40 shadow-lg overflow-y-auto no-print">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-bold">História cyklov</h2>
    <button id="close-history-btn" class="text-2xl font-bold">×</button>
  </div>
  <div id="history-list" class="space-y-4"></div>
  <button id="delete-history-btn" class="mt-4 w-full px-6 py-2.5 bg-red-600 text-white font-bold rounded-lg">
    Vymazať celú históriu
  </button>
  <button id="back-to-current-btn" class="mt-4 w-full px-6 py-2.5 bg-gray-500 text-white font-bold rounded-lg">
    Späť na aktuálny cyklus
  </button>
</div>

<div class="print-area"></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
// === STAV APLIKÁCIE ===
let expenses = [];
let pieChart;
let budgetChart;
let monthlyIncome = 0;
let monthlyBudget = {};
let messageTimeout;
let cycleStartDate = null;
let isHistoryView = false;
let historicalCycles = [];

// KATEGÓRIE vrátane vlastnej položky
const expenseCategories = [
  'Nájomné','Internet','Elektrika','Kúrenie','Poistka za auto',
  'Poistenie zodpovednosti za byt','Potraviny','Doprava','Zábava',
  'Cigarety','Alkohol','Ostatné','Vlastná položka'
];


// === LOCAL STORAGE ===
function saveDataToLocalStorage() {
  const data = {
    expenses,
    monthlyIncome,
    monthlyBudget,
    cycleStartDate: cycleStartDate ? cycleStartDate.toISOString() : null
  };
  localStorage.setItem('currentCycleData', JSON.stringify(data));
}

function loadDataFromLocalStorage() {
  const saved = localStorage.getItem('currentCycleData');
  if (saved) {
    const d = JSON.parse(saved);
    expenses = d.expenses || [];
    monthlyIncome = d.monthlyIncome || 0;
    monthlyBudget = d.monthlyBudget || {};
    cycleStartDate = d.cycleStartDate ? new Date(d.cycleStartDate) : null;
  }

  const hist = localStorage.getItem('historicalCycles');
  if (hist) historicalCycles = JSON.parse(hist);
}

function saveHistoricalCycles() {
  localStorage.setItem('historicalCycles', JSON.stringify(historicalCycles));
}


// === POMOCNÉ FUNKCIE ===
function showMessage(msg, type = 'success') {
  const box = document.getElementById('message-box');
  const text = document.getElementById('message-text');

  clearTimeout(messageTimeout);
  text.textContent = msg;

  box.classList.remove('hidden', 'bg-green-500', 'bg-red-500', 'bg-blue-500');
  box.classList.add(
    type === 'error' ? 'bg-red-500' :
    type === 'info' ?  'bg-blue-500' :
    'bg-green-500'
  );

  messageTimeout = setTimeout(() => box.classList.add('hidden'), 3000);
}

function showConfirmationDialog(message, onConfirm) {
  const dialog = document.getElementById('confirmation-dialog');
  const msg = document.getElementById('confirmation-message');

  msg.textContent = message;
  dialog.classList.remove('hidden');

  const confirmBtn = document.getElementById('confirm-btn');
  const cancelBtn = document.getElementById('cancel-btn');

  const close = () => {
    dialog.classList.add('hidden');
    confirmBtn.removeEventListener('click', ok);
    cancelBtn.removeEventListener('click', ko);
  };

  const ok = () => { onConfirm(); close(); };
  const ko = () => close();

  confirmBtn.addEventListener('click', ok);
  cancelBtn.addEventListener('click', ko);

  dialog.addEventListener('click', e => {
    if (e.target === dialog) close();
  });
}


// === UI ===
function renderUI() {
  const cat = document.getElementById('expense-category');
  const bcat = document.getElementById('budget-category-select');

  cat.innerHTML = '';
  bcat.innerHTML = '';

  expenseCategories.forEach(c => {
    const opt = `<option value="${c}">${c}</option>`;
    cat.innerHTML += opt;

    if (c !== 'Vlastná položka') bcat.innerHTML += opt;
  });

  const first = bcat.value;
  document.getElementById('budget-amount-input').value =
    monthlyBudget[first] || '';

  bcat.addEventListener('change', e => {
    const c = e.target.value;
    document.getElementById('budget-amount-input').value = monthlyBudget[c] || '';
    updateBudgetRuleChart();
  });

  // Vlastná položka — zobrazenie políčka
  document.getElementById('expense-category').addEventListener('change', e => {
    const v = e.target.value;
    const box = document.getElementById('custom-category-box');

    if (v === 'Vlastná položka') box.classList.remove('hidden');
    else box.classList.add('hidden');
  });
}


// === PRIDANIE VÝDAVKU + CUSTOM položka ===
function handleAddExpense() {
  if (isHistoryView) {
    showMessage('Nemôžete pridávať výdavky v historickom cykle.', 'error');
    return;
  }

  let category = document.getElementById('expense-category').value;
  let custom = document.getElementById('custom-category-input').value.trim();

  if (category === 'Vlastná položka') {
    if (!custom) {
      showMessage('Zadajte názov vlastnej položky.', 'error');
      return;
    }
    category = custom;
  }

  const amount = parseFloat(document.getElementById('expense-amount').value);
  if (isNaN(amount) || amount <= 0) {
    showMessage('Zadajte platnú sumu.', 'error');
    return;
  }

  if (!cycleStartDate) cycleStartDate = new Date();

  expenses.push({
    date: new Date().toISOString(),
    category,
    amount
  });

  document.getElementById('expense-amount').value = '';
  document.getElementById('custom-category-input').value = '';

  saveDataToLocalStorage();
  showMessage('Výdavok bol pridaný!');
  renderAllUI();
}


// === ULOŽENIE PRÍJMU ===
function handleSaveIncome() {
  if (isHistoryView) {
    showMessage('V historickom cykle nie je možné meniť príjem.', 'error');
    return;
  }

  const val = parseFloat(document.getElementById('monthly-income-input').value);
  if (isNaN(val) || val < 0) {
    showMessage('Neplatná suma príjmu.', 'error');
    return;
  }

  monthlyIncome = val;
  if (!cycleStartDate) cycleStartDate = new Date();

  saveDataToLocalStorage();
  showMessage('Príjem bol uložený.');
  renderAllUI();
}


// === BUDGET ===
function handleSaveBudget() {
  if (isHistoryView) {
    showMessage('Nie je možné meniť rozpočet v historickom cykle.', 'error');
    return;
  }

  const category = document.getElementById('budget-category-select').value;
  const val = parseFloat(document.getElementById('budget-amount-input').value);

  if (isNaN(val) || val < 0) {
    showMessage('Zadajte platnú sumu rozpočtu.', 'error');
    return;
  }

  monthlyBudget[category] = val;
  saveDataToLocalStorage();
  showMessage('Rozpočet uložený.');
  renderAllUI();
}


// === MAZANIE AKTUÁLNEHO CYKLU ===
function handleDeleteCurrentCycle() {
  if (isHistoryView) {
    showMessage('V historickom cykle nie je možné mazať dáta.', 'error');
    return;
  }

  if (expenses.length === 0 && monthlyIncome === 0 && Object.keys(monthlyBudget).length === 0) {
    showMessage('Nie je čo mazať.', 'error');
    return;
  }

  showConfirmationDialog(
    'Naozaj chcete vymazať celý aktuálny cyklus?',
    () => {
      localStorage.removeItem('currentCycleData');
      expenses = [];
      monthlyIncome = 0;
      monthlyBudget = {};
      cycleStartDate = null;

      showMessage('Aktuálny cyklus vymazaný.');
      renderAllUI();
    }
  );
}


// === SUMÁR, TABUĽKA, GRAFY ===
function updateBudgetSummary() {
  const total = expenses.reduce((s, e) => s + e.amount, 0);
  const rem = monthlyIncome - total;

  document.getElementById('total-spent').textContent = `${total.toFixed(2)} €`;
  document.getElementById('remaining-budget').textContent = `${rem.toFixed(2)} €`;
}

function renderTable() {
  const body = document.getElementById('expense-table-body');
  body.innerHTML = '';

  const sorted = [...expenses].sort((a, b) => new Date(b.date) - new Date(a.date));

  if (sorted.length === 0) {
    body.innerHTML =
      `<tr><td colspan="2" class="py-3 text-center text-gray-500">Žiadne dáta.</td></tr>`;
    return;
  }

  sorted.forEach(e => {
    const tr =
      `<tr class="border-b border-gray-200">
        <td class="py-3 px-6">${new Date(e.date).toLocaleDateString('sk-SK')} - ${e.category}</td>
        <td class="py-3 px-6 text-red-600">-${e.amount.toFixed(2)} €</td>
      </tr>`;

    body.innerHTML += tr;
  });
}


// === PIE CHART (percentá v grafe) ===
const pieLabelsPlugin = {
  id: 'pieLabelsPlugin',
  afterDraw(chart) {
    const { ctx, data } = chart;
    const meta = chart.getDatasetMeta(0);

    if (!meta || !meta.data.length) return;

    const total = data.datasets[0].data.reduce((s, v) => s + v, 0);

    ctx.save();

    meta.data.forEach((slice, i) => {
      const value = data.datasets[0].data[i];
      if (!value) return;

      const percent = ((value / total) * 100).toFixed(0);

      const label = `${data.labels[i]} ${percent}%`;

      const angle = (slice.startAngle + slice.endAngle) / 2;
      const r = slice.outerRadius * 0.6;
      const x = slice.x + r * Math.cos(angle);
      const y = slice.y + r * Math.sin(angle);

      ctx.fillStyle = '#000';
      ctx.font = 'bold 12px Inter';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';

      ctx.fillText(label, x, y);
    });

    ctx.restore();
  }
};

function updateChart() {
  const totals = expenses.reduce((a, e) => {
    a[e.category] = (a[e.category] || 0) + e.amount;
    return a;
  }, {});

  const labels = Object.keys(totals);
  const data = Object.values(totals);

  if (pieChart) pieChart.destroy();

  const ctx = document.getElementById('expense-pie-chart').getContext('2d');

  pieChart = new Chart(ctx, {
    type: 'pie',
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: [
          '#ef4444','#3b82f6','#f59e0b','#10b981','#6366f1',
          '#ec4899','#34d399','#f97316','#a78bfa','#d946ef',
          '#4b5563','#9ca3af'
        ],
        borderColor: '#fff',
        borderWidth: 2
      }]
    },
    options: { plugins: { legend: { display: false } } },
    plugins: [pieLabelsPlugin]
  });

  // súhrn pod grafom
  let summary = '';
  labels.forEach((l, i) => {
    summary += `<div class="flex justify-between py-1 border-b border-dashed">
      <span>${l}</span>
      <span class="font-semibold">${data[i].toFixed(2)} €</span>
    </div>`;
  });

  document.getElementById('chart-summary').innerHTML =
    labels.length ? summary : '<p class="text-center text-gray-500">Žiadne dáta.</p>';
}


// === BAR CHART ===
function updateBudgetRuleChart() {
  const cats = Object.keys(monthlyBudget);

  const container = document.getElementById('budget-bar-chart-container');

  if (cats.length === 0) {
    container.classList.add('hidden');
    if (budgetChart) budgetChart.destroy();
    return;
  }

  container.classList.remove('hidden');

  const spent = cats.map(c =>
    expenses.filter(e => e.category === c).reduce((s, e) => s + e.amount, 0)
  );

  const budget = cats.map(c => monthlyBudget[c] || 0);

  if (budgetChart) budgetChart.destroy();

  const ctx = document.getElementById('budget-bar-chart').getContext('2d');

  budgetChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: cats,
      datasets: [
        {
          label: 'Rozpočet',
          data: budget,
          backgroundColor: 'rgba(75,192,192,0.5)'
        },
        {
          label: 'Minuté',
          data: spent,
          backgroundColor: spent.map((v,i)=> v>budget[i] ? 'rgba(255,99,132,0.5)' : 'rgba(54,162,235,0.5)')
        }
      ]
    },
    options: { responsive: true }
  });
}


// === ZOBRAZENIE DÁTUMOV ===
function updateCycleDatesDisplay(start = cycleStartDate, end = null) {
  const el = document.getElementById('cycle-dates');

  const s = start ? start.toLocaleDateString('sk-SK') : 'N/A';
  const e = end ? end.toLocaleDateString('sk-SK') : 'N/A';

  if (isHistoryView && start && end)
    el.textContent = `Cyklus od ${s} do ${e}.`;
  else if (start)
    el.textContent = `Sledovanie od ${s}.`;
  else
    el.textContent = `Začnite pridaním výdavku.`;
}


// === HISTÓRIA, CYKLY ===
function startNewCycle() {
  if (expenses.length === 0 && monthlyIncome === 0 && Object.keys(monthlyBudget).length === 0) {
    showMessage('Nie je čo ukladať.', 'error');
    return;
  }

  showConfirmationDialog('Ukončiť cyklus a začať nový?', () => {
    const end = new Date();

    historicalCycles.push({
      id: end.getTime(),
      expenses,
      monthlyIncome,
      monthlyBudget,
      cycleStartDate: cycleStartDate.toISOString(),
      cycleEndDate: end.toISOString()
    });

    saveHistoricalCycles();

    expenses = [];
    monthlyIncome = 0;
    monthlyBudget = {};
    cycleStartDate = null;

    saveDataToLocalStorage();

    renderAllUI();
    showMessage('Nový cyklus spustený.');
  });
}

function renderHistorySidebar() {
  const box = document.getElementById('history-list');
  box.innerHTML = '';

  if (historicalCycles.length === 0) {
    box.innerHTML = `<p class="text-gray-400">Žiadna história.</p>`;
    return;
  }

  [...historicalCycles].sort((a, b) => b.id - a.id).forEach(c => {
    const s = new Date(c.cycleStartDate).toLocaleDateString('sk-SK');
    const e = new Date(c.cycleEndDate).toLocaleDateString('sk-SK');

    const total = c.expenses.reduce((s, e) => s + e.amount, 0);
    const remaining = c.monthlyIncome - total;

    const div = document.createElement('div');
    div.className =
      'bg-gray-800 p-4 rounded-lg flex justify-between items-center';

    div.innerHTML = `
      <div class="flex-grow cursor-pointer">
        <h4 class="font-bold">${s} → ${e}</h4>
        <p class="text-sm text-gray-400">Príjem: ${c.monthlyIncome.toFixed(2)} €</p>
        <p class="text-sm text-gray-400">Zostatok: ${remaining.toFixed(2)} €</p>
      </div>
      <button class="text-red-400 hover:text-red-300 ml-4"><i class="fas fa-trash"></i></button>
    `;

    div.firstElementChild.addEventListener('click', () => loadArchivedCycle(c.id));

    div.lastElementChild.addEventListener('click', e => {
      e.stopPropagation();
      deleteSingleCycle(c.id, `${s} - ${e}`);
    });

    box.appendChild(div);
  });
}

function loadArchivedCycle(id) {
  const d = historicalCycles.find(c => c.id == id);
  if (!d) return;

  expenses = d.expenses;
  monthlyIncome = d.monthlyIncome;
  monthlyBudget = d.monthlyBudget;
  cycleStartDate = new Date(d.cycleStartDate);

  updateCycleDatesDisplay(new Date(d.cycleStartDate), new Date(d.cycleEndDate));

  isHistoryView = true;
  renderAllUI();

  document.getElementById('history-sidebar').classList.add('translate-x-full');
}

function deleteSingleCycle(id, label) {
  showConfirmationDialog(`Vymazať cyklus: ${label}?`, () => {
    historicalCycles = historicalCycles.filter(c => c.id !== id);
    saveHistoricalCycles();
    renderHistorySidebar();
    showMessage('Cyklus vymazaný.');
  });
}

function backToCurrentCycle() {
  isHistoryView = false;
  loadDataFromLocalStorage();
  renderAllUI();
  showMessage('Aktuálny cyklus.');
}


// === RENDER VŠETKÉHO ===
function renderAllUI() {
  document.getElementById('history-view-message')
    .classList.toggle('hidden', !isHistoryView);

  document.getElementById('current-cycle-forms')
    .classList.toggle('hidden', isHistoryView);

  document.getElementById('delete-current-cycle-btn')
    .classList.toggle('hidden', isHistoryView);

  renderTable();
  updateBudgetSummary();
  updateChart();
  updateBudgetRuleChart();
  updateBudgetStatus();
  updateCycleDatesDisplay();
}


// === ŠTART ===
document.addEventListener('DOMContentLoaded', () => {
  loadDataFromLocalStorage();
  renderUI();
  renderAllUI();

  document.getElementById('add-expense-btn').addEventListener('click', handleAddExpense);
  document.getElementById('save-income-btn').addEventListener('click', handleSaveIncome);
  document.getElementById('save-budget-btn').addEventListener('click', handleSaveBudget);
  document.getElementById('delete-current-cycle-btn').addEventListener('click', handleDeleteCurrentCycle);
  document.getElementById('start-new-cycle-btn').addEventListener('click', startNewCycle);

  document.getElementById('view-history-btn').addEventListener('click', () => {
    renderHistorySidebar();
    document.getElementById('history-sidebar').classList.remove('translate-x-full');
  });

  document.getElementById('close-history-btn').addEventListener('click', () => {
    document.getElementById('history-sidebar').classList.add('translate-x-full');
  });

  document.getElementById('back-to-current-btn').addEventListener('click', backToCurrentCycle);
  document.getElementById('delete-history-btn').addEventListener('click', () => {
    showConfirmationDialog('Vymazať celú históriu?', () => {
      historicalCycles = [];
      saveHistoricalCycles();
      renderHistorySidebar();
      showMessage('História vymazaná.');
    });
  });
});

// === SERVICE WORKER ===
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/cyklus-vydavkov/sw.js');
}

</script>

</body>
</html>
